<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MRI-3T-taskfMRI &mdash; Hippomaps 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=264bf13b"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tools Index" href="../api.html" />
    <link rel="prev" title="Dimensionality-Reduction" href="DimReduct.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Hippomaps
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Morphology.html">Morphology</a></li>
<li class="toctree-l2"><a class="reference internal" href="Histology-MRI-9p4T.html">Histology-MRI-9p4T</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-7T-struct.html">MRI-7T-struct</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-rsfMRI.html">MRI-3T-rsfMRI</a></li>
<li class="toctree-l2"><a class="reference internal" href="iEEG.html">iEEG</a></li>
<li class="toctree-l2"><a class="reference internal" href="DimReduct.html">Dimensionality-Reduction</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">MRI-3T-taskfMRI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#0)-Map-data-to-hippocampal-surface">0) Map data to hippocampal surface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1)-Mnemonic-Similarity-Task-(Pattern-Separation)">1) Mnemonic Similarity Task (Pattern Separation)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.1)-GLM-fit">1.1) GLM fit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.2)-Group-averaging-and-significance/consistency-testing">1.2) Group-averaging and significance/consistency testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.3)-Consider-neocortical-results">1.3) Consider neocortical results</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.4)-Compare-to-previously-mapped-features">1.4) Compare to previously mapped features</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2)-Episodic-Retrieval">2) Episodic Retrieval</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.1)-GLM-fit">2.1) GLM fit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.2)-Group-averaging-and-significance/consistency-testing">2.2) Group-averaging and significance/consistency testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.3)-Consider-the-neocortex">2.3) Consider the neocortex</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3)-Episodic-encoding--subsequent-memory">3) Episodic encoding -subsequent memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3.1)-GLM-fit">3.1) GLM fit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3.2)-Group-averaging-and-significance/consistency-testing">3.2) Group-averaging and significance/consistency testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3.3)-Consider-the-neocortex">3.3) Consider the neocortex</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Tools Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">References &amp; Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Hippomaps</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">MRI-3T-taskfMRI</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="MRI-3T-taskfMRI">
<h1>MRI-3T-taskfMRI<a class="headerlink" href="#MRI-3T-taskfMRI" title="Permalink to this heading"></a></h1>
<p><strong>Overview</strong></p>
<p>This tutorial will differ from the others, in that it can’t be run using only checkpoint data but rather requires the original datasets. This is because different subjects have a different number of volumes (or TRs) depending on how long it took them to complete the tasks. Each subject will also have an events.tsv file indicating trial onset times and responses. Thus, this tutorial cannot easily be run online, but we include it here as an illustrative example nonetheless.</p>
<p>section 1) will deal with the Mneumonic Similarity Task (MST). This will involve 1.1) A full walkthrough of one subject analysis, and then looping over subjects, 1.2) Plotting group-level data and significance testing, 1.3) Applying the same to the neocortex instead of hippocampus, and 1.4) Contextualizing resulting hippocampal maps by direct spatial correlation to other HippoMaps features</p>
<p>We will then apply the same steps to 2) an item-pairing task retrieval phase and 3) the same task encoding phase</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">hippomaps</span> <span class="k">as</span> <span class="nn">hm</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">nilearn</span>
<span class="kn">from</span> <span class="nn">nilearn.glm.first_level</span> <span class="kn">import</span> <span class="n">make_first_level_design_matrix</span>
<span class="kn">from</span> <span class="nn">nilearn.glm.first_level</span> <span class="kn">import</span> <span class="n">run_glm</span>
<span class="kn">from</span> <span class="nn">nilearn.glm.contrasts</span> <span class="kn">import</span> <span class="n">compute_contrast</span>
<span class="kn">from</span> <span class="nn">brainspace.mesh.mesh_io</span> <span class="kn">import</span> <span class="n">read_surface</span>
<span class="kn">from</span> <span class="nn">brainspace.plotting</span> <span class="kn">import</span> <span class="n">plot_hemispheres</span>
<span class="kn">from</span> <span class="nn">brainspace.datasets</span> <span class="kn">import</span> <span class="n">load_group_fc</span><span class="p">,</span> <span class="n">load_parcellation</span><span class="p">,</span> <span class="n">load_conte69</span>
<span class="kn">from</span> <span class="nn">brainspace.utils.parcellation</span> <span class="kn">import</span> <span class="n">map_to_labels</span>
<span class="kn">import</span> <span class="nn">glob</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/export03/data/opt/venv/lib/python3.8/site-packages/nilearn/datasets/__init__.py:93: FutureWarning: Fetchers from the nilearn.datasets module will be updated in version 0.9 to return python strings instead of bytes and Pandas dataframes instead of Numpy arrays.
  warn(&#34;Fetchers from the nilearn.datasets module will be &#34;
/export03/data/opt/venv/lib/python3.8/site-packages/nilearn/glm/__init__.py:55: FutureWarning: The nilearn.glm module is experimental. It may change in any future release of Nilearn.
  warn(&#39;The nilearn.glm module is experimental. &#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># locate input data</span>
<span class="n">ses</span> <span class="o">=</span> <span class="s1">&#39;01&#39;</span>
<span class="n">micapipe_dir</span> <span class="o">=</span> <span class="s1">&#39;/data/mica3/BIDS_MICs/derivatives/micapipe_v0.2.0&#39;</span>
<span class="n">micapipe_raw</span> <span class="o">=</span> <span class="s1">&#39;/data/mica3/BIDS_MICs/rawdata/&#39;</span> <span class="c1"># this we need for the events.tsv files</span>
<span class="n">hippunfold_dir</span> <span class="o">=</span> <span class="s1">&#39;/data/mica3/BIDS_MICs/derivatives/hippunfold_v1.3.0/hippunfold&#39;</span>

<span class="c1"># define which subjects and surfaces to examine</span>
<span class="n">subs</span> <span class="o">=</span> <span class="p">[</span>
 <span class="s1">&#39;HC001&#39;</span><span class="p">,</span> <span class="s1">&#39;HC002&#39;</span><span class="p">,</span> <span class="s1">&#39;HC005&#39;</span><span class="p">,</span> <span class="s1">&#39;HC006&#39;</span><span class="p">,</span> <span class="s1">&#39;HC007&#39;</span><span class="p">,</span> <span class="s1">&#39;HC011&#39;</span><span class="p">,</span> <span class="s1">&#39;HC012&#39;</span><span class="p">,</span> <span class="s1">&#39;HC013&#39;</span><span class="p">,</span> <span class="s1">&#39;HC014&#39;</span><span class="p">,</span> <span class="s1">&#39;HC015&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HC016&#39;</span><span class="p">,</span> <span class="s1">&#39;HC017&#39;</span><span class="p">,</span> <span class="s1">&#39;HC018&#39;</span><span class="p">,</span> <span class="s1">&#39;HC019&#39;</span><span class="p">,</span> <span class="s1">&#39;HC020&#39;</span><span class="p">,</span> <span class="s1">&#39;HC021&#39;</span><span class="p">,</span> <span class="s1">&#39;HC022&#39;</span><span class="p">,</span> <span class="s1">&#39;HC023&#39;</span><span class="p">,</span> <span class="s1">&#39;HC025&#39;</span><span class="p">,</span> <span class="s1">&#39;HC026&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HC027&#39;</span><span class="p">,</span> <span class="s1">&#39;HC028&#39;</span><span class="p">,</span> <span class="s1">&#39;HC029&#39;</span><span class="p">,</span> <span class="s1">&#39;HC030&#39;</span><span class="p">,</span> <span class="s1">&#39;HC031&#39;</span><span class="p">,</span> <span class="s1">&#39;HC032&#39;</span><span class="p">,</span> <span class="s1">&#39;HC033&#39;</span><span class="p">,</span> <span class="s1">&#39;HC034&#39;</span><span class="p">,</span> <span class="s1">&#39;HC035&#39;</span><span class="p">,</span> <span class="s1">&#39;HC036&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HC037&#39;</span><span class="p">,</span> <span class="s1">&#39;HC038&#39;</span><span class="p">,</span> <span class="s1">&#39;HC039&#39;</span><span class="p">,</span> <span class="s1">&#39;HC040&#39;</span><span class="p">,</span> <span class="s1">&#39;HC041&#39;</span><span class="p">,</span> <span class="s1">&#39;HC042&#39;</span><span class="p">,</span> <span class="s1">&#39;HC043&#39;</span><span class="p">,</span> <span class="s1">&#39;HC044&#39;</span><span class="p">,</span> <span class="s1">&#39;HC045&#39;</span><span class="p">,</span> <span class="s1">&#39;HC046&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HC047&#39;</span><span class="p">,</span> <span class="s1">&#39;HC048&#39;</span><span class="p">,</span> <span class="s1">&#39;HC049&#39;</span><span class="p">,</span> <span class="s1">&#39;HC050&#39;</span><span class="p">,</span> <span class="s1">&#39;HC051&#39;</span><span class="p">,</span> <span class="s1">&#39;HC052&#39;</span><span class="p">,</span> <span class="s1">&#39;HC053&#39;</span><span class="p">,</span> <span class="s1">&#39;HC054&#39;</span><span class="p">,</span> <span class="s1">&#39;HC055&#39;</span><span class="p">,</span> <span class="s1">&#39;HC056&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HC057&#39;</span><span class="p">,</span> <span class="s1">&#39;HC058&#39;</span><span class="p">,</span> <span class="s1">&#39;HC059&#39;</span><span class="p">,</span> <span class="s1">&#39;HC060&#39;</span><span class="p">,</span> <span class="s1">&#39;HC061&#39;</span><span class="p">,</span> <span class="s1">&#39;HC063&#39;</span><span class="p">,</span> <span class="s1">&#39;HC065&#39;</span><span class="p">,</span> <span class="s1">&#39;HC067&#39;</span><span class="p">,</span> <span class="s1">&#39;HC068&#39;</span><span class="p">,</span> <span class="s1">&#39;HC069&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HC070&#39;</span><span class="p">,</span> <span class="s1">&#39;HC071&#39;</span><span class="p">,</span> <span class="s1">&#39;HC072&#39;</span><span class="p">,</span> <span class="s1">&#39;HC074&#39;</span><span class="p">,</span> <span class="s1">&#39;HC075&#39;</span><span class="p">,</span> <span class="s1">&#39;HC077&#39;</span><span class="p">,</span> <span class="s1">&#39;HC078&#39;</span><span class="p">,</span> <span class="s1">&#39;HC081&#39;</span><span class="p">,</span> <span class="s1">&#39;HC082&#39;</span><span class="p">,</span> <span class="s1">&#39;HC084&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HC086&#39;</span><span class="p">,</span> <span class="s1">&#39;HC087&#39;</span><span class="p">,</span> <span class="s1">&#39;HC088&#39;</span><span class="p">,</span> <span class="s1">&#39;HC089&#39;</span><span class="p">,</span> <span class="s1">&#39;HC090&#39;</span><span class="p">,</span> <span class="s1">&#39;HC093&#39;</span><span class="p">,</span> <span class="s1">&#39;HC097&#39;</span><span class="p">,</span> <span class="s1">&#39;HC100&#39;</span><span class="p">,</span> <span class="s1">&#39;HC024&#39;</span><span class="p">,</span> <span class="s1">&#39;HC064&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HC073&#39;</span><span class="p">,</span> <span class="s1">&#39;HC101&#39;</span><span class="p">]</span>
<span class="n">hemis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hipp&#39;</span><span class="p">]</span><span class="c1"># ,&#39;dentate&#39;]</span>
<span class="n">den</span><span class="o">=</span><span class="s1">&#39;2mm&#39;</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Gaussian smoothing kernal sigma (mm) to apply to surface data</span>
<span class="n">TR</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="c1"># repetition time (seconds)</span>
<span class="n">tasks</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MST2&#39;</span><span class="p">,</span> <span class="s1">&#39;encoding&#39;</span><span class="p">,</span><span class="s1">&#39;retrieval&#39;</span><span class="p">]</span>
<span class="n">slice_time_ref</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># get expected number of vertices and their indices</span>
<span class="n">nV</span><span class="p">,</span><span class="n">iV</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_nVertices</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">den</span><span class="p">)</span>

<span class="c1"># Load neocortical surfaces for visualzation (assets from micapipe)</span>
<span class="n">parcL</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/data/mica1/01_programs/micapipe-v0.2.0/parcellations/schaefer-400_conte69_lh.label.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">parcR</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/data/mica1/01_programs/micapipe-v0.2.0/parcellations/schaefer-400_conte69_rh.label.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">nP</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">parcL</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># number of neocortical parcels (one hemisphere)</span>
<span class="n">iP</span> <span class="o">=</span> <span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="p">,</span><span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">parc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">parcL</span><span class="p">,</span><span class="n">parcR</span><span class="p">))</span>
<span class="n">c69_inf_lh</span><span class="o">=</span> <span class="n">read_surface</span><span class="p">(</span><span class="s1">&#39;/data/mica1/01_programs/micapipe-v0.2.0/surfaces/fsLR-32k.L.inflated.surf.gii&#39;</span><span class="p">,</span> <span class="n">itype</span><span class="o">=</span><span class="s1">&#39;gii&#39;</span><span class="p">)</span>
<span class="n">c69_inf_rh</span> <span class="o">=</span> <span class="n">read_surface</span><span class="p">(</span><span class="s1">&#39;/data/mica1/01_programs/micapipe-v0.2.0/surfaces/fsLR-32k.R.inflated.surf.gii&#39;</span><span class="p">,</span> <span class="n">itype</span><span class="o">=</span><span class="s1">&#39;gii&#39;</span><span class="p">)</span>
<span class="n">labels_c69</span> <span class="o">=</span> <span class="n">load_parcellation</span><span class="p">(</span><span class="s1">&#39;schaefer&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="0)-Map-data-to-hippocampal-surface">
<h2>0) Map data to hippocampal surface<a class="headerlink" href="#0)-Map-data-to-hippocampal-surface" title="Permalink to this heading"></a></h2>
<p>In this example, we loop through subjects and hemispheres, and sample volumetric timeseries data onto hippocampal surfaces. We then apply smoothing. Finally, we save the data from all surfaces into <code class="docutils literal notranslate"><span class="pre">.func.gii</span></code> files.</p>
<p>NOTE: here we save surface fMRI data into a <code class="docutils literal notranslate"><span class="pre">surf/task-fMRI/</span></code> directory within our hippunfold directory. Depending on your lab organization, it may be best to never write project-specific outputs into a shared processed dataset, so consider writing to your own directory instead!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>tmp
<span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="o">!{</span>f<span class="s1">&#39;mkdir -p {hippunfold_dir}/sub-{sub}/ses-{ses}/surf/task-fMRI/{task}&#39;</span><span class="o">}</span>

        <span class="c1"># convert affines</span>
        <span class="n">cmd1a</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;c3d_affine_tool &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;-itk </span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/xfm/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_from-se_task-</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_acq-AP_bold_to-nativepro_mode-image_desc-affine_0GenericAffine.mat &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;-o </span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_tmp0GenericAffine0.txt&#39;</span>
        <span class="o">!{</span>cmd1a<span class="o">}</span>
        <span class="n">cmd1b</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;c3d_affine_tool &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;-itk </span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/xfm/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_from-nativepro_func_to-se_task-</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_acq-AP_bold_mode-image_desc-SyN_0GenericAffine.mat &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;-inv &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;-o </span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_tmp0GenericAffine1.txt&#39;</span>
        <span class="o">!{</span>cmd1b<span class="o">}</span>

        <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_smooth-</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s1">mm.func.gii&#39;</span><span class="p">):</span>
                    <span class="c1">#apply affines</span>
                    <span class="n">cmd2a</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -surface-apply-affine &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-0p5mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_midthickness.surf.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_tmp0GenericAffine0.txt &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_aff0.surf.gii&#39;</span>
                    <span class="o">!{</span>cmd2a<span class="o">}</span>
                    <span class="n">cmd2b</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -surface-apply-affine &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_aff0.surf.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_tmp0GenericAffine1.txt &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_aff1.surf.gii&#39;</span>
                    <span class="o">!{</span>cmd2b<span class="o">}</span>
                    <span class="c1"># apply warp (Note this is actually the INVERSE warp)</span>
                    <span class="n">cmd3</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -surface-apply-warpfield &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_aff1.surf.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/xfm/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_from-nativepro_func_to-se_task-</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_acq-AP_bold_mode-image_desc-SyN_1Warp.nii.gz &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_deform.surf.gii&#39;</span>
                    <span class="o">!{</span>cmd3<span class="o">}</span>

                    <span class="c1"># sample</span>
                    <span class="n">cmd4</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -volume-to-surface-mapping &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_acq-AP_bold/volumetric/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_space-func_desc-se_preproc.nii.gz &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_deform.surf.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">.func.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;-enclosing&#39;</span>
                    <span class="o">!{</span>cmd4<span class="o">}</span>

                    <span class="c1"># smooth</span>
                    <span class="n">cmd5</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -metric-smoothing &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-0p5mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_midthickness.surf.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">.func.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s1"> &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_smooth.func.gii &#39;</span>
                    <span class="o">!{</span>cmd5<span class="o">}</span>

                    <span class="c1"># downsample</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_smooth.func.gii&#39;</span><span class="p">)</span>
                    <span class="n">out_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">darrays</span><span class="p">),</span><span class="n">nV</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">darrays</span><span class="p">)):</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">density_interp</span><span class="p">(</span><span class="s1">&#39;0p5mm&#39;</span><span class="p">,</span> <span class="s1">&#39;2mm&#39;</span><span class="p">,</span><span class="n">func</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                        <span class="n">out_array</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="n">data_array</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">out_array</span><span class="p">)</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>
                    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s1">_smooth-</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s1">mm.func.gii&#39;</span><span class="p">)</span>
<span class="o">!</span>rm<span class="w"> </span>-r<span class="w"> </span>tmp
</pre></div>
</div>
</div>
</section>
<section id="1)-Mnemonic-Similarity-Task-(Pattern-Separation)">
<h2>1) Mnemonic Similarity Task (Pattern Separation)<a class="headerlink" href="#1)-Mnemonic-Similarity-Task-(Pattern-Separation)" title="Permalink to this heading"></a></h2>
</section>
<section id="1.1)-GLM-fit">
<h2>1.1) GLM fit<a class="headerlink" href="#1.1)-GLM-fit" title="Permalink to this heading"></a></h2>
<p>First we will walk through how this can be done for one subject, and then we will loop through all subjects</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sub</span> <span class="o">=</span> <span class="n">subs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># first subject</span>
<span class="n">current_task</span><span class="o">=</span><span class="s1">&#39;MST2&#39;</span>
<span class="c1">#list all possible combination of correct answer(target) and subject response</span>
<span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;oldold&#39;</span><span class="p">,</span> <span class="s1">&#39;similarsimilar&#39;</span><span class="p">,</span> <span class="s1">&#39;newnew&#39;</span><span class="p">,</span> <span class="s1">&#39;oldsimilar&#39;</span><span class="p">,</span> <span class="s1">&#39;oldnew&#39;</span><span class="p">,</span> <span class="s1">&#39;similarold&#39;</span><span class="p">,</span> <span class="s1">&#39;similarnew&#39;</span><span class="p">,</span> <span class="s1">&#39;newold&#39;</span><span class="p">,</span> <span class="s1">&#39;newsimilar&#39;</span><span class="p">]</span>

<span class="c1"># load in regressors of no interest generated by micapipe</span>
<span class="n">motion_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-MST2_acq-AP_bold/volumetric/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_space-func_desc-se.1D&#39;</span><span class="p">)</span>
<span class="c1"># Specify the timing of fmri frames</span>
<span class="n">frame_times</span> <span class="o">=</span> <span class="n">TR</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">motion_reg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">slice_time_ref</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">motion_reg</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_7_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_7_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create design matrix</span>

<span class="c1"># Load event files</span>
<span class="n">events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_raw</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_task-MST2_events.tsv&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">events</span><span class="p">[[</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">,</span><span class="s1">&#39;event_1_duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_2_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_3_onset&#39;</span><span class="p">,</span><span class="s1">&#39;response_time&#39;</span><span class="p">]]</span>
<span class="c1"># Recode events to have easy-to-read names</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation&#39;</span><span class="p">,</span> <span class="s1">&#39;event_1_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation_dur&#39;</span><span class="p">,</span><span class="s1">&#39;event_2_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_3_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;keypress&#39;</span><span class="p">})</span>
<span class="c1"># Combine response and condition to get all possible combinations</span>
<span class="n">true_con</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">events</span><span class="p">[</span><span class="s2">&quot;subject response&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_con</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">max_rows</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>

<span class="n">design_matrix</span> <span class="o">=</span> <span class="n">make_first_level_design_matrix</span><span class="p">(</span><span class="n">frame_times</span><span class="p">,</span>
                                              <span class="n">events</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                                              <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative + dispersion&#39;</span><span class="p">,</span>
                                              <span class="n">add_regs</span><span class="o">=</span><span class="n">motion_reg</span><span class="p">)</span>

<span class="c1"># in some cases, there are no trials of a certain type (eg. someone never pressed &quot;new&quot; to and &quot;old&quot; stimulus.</span>
<span class="c1"># in this case add extra columns to the design matrix with all 0s</span>
<span class="c1"># this will help us look at all trial types later</span>
<span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Create columns for condition, its derivatives, and dispersion</span>
        <span class="n">design_matrix</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">design_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">_derivative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">design_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">_dispersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># plot design matrix</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Design Matrix for Subject </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Regressors&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Time Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Regressor Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
    fixation  fixation_dur    onset  duration  keypress  response_time      trial_type
0      2.030         2.826    4.856       2.0     6.445          1.589          oldold
1      6.857         2.718    9.576       2.0    11.357          1.781  similarsimilar
..       ...           ...      ...       ...       ...            ...             ...
94   425.902         2.218  428.120       2.0   429.039          0.919          newnew
95   430.122         3.019  433.141       2.0   434.602          1.461      oldsimilar
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/export03/data/opt/venv/lib/python3.8/site-packages/nilearn/glm/first_level/experimental_paradigm.py:89: UserWarning: Unexpected column `keypress` in events data will be ignored.
  warnings.warn((&#34;Unexpected column `{}` in events &#34;
/export03/data/opt/venv/lib/python3.8/site-packages/nilearn/glm/first_level/experimental_paradigm.py:89: UserWarning: Unexpected column `response_time` in events data will be ignored.
  warnings.warn((&#34;Unexpected column `{}` in events &#34;
/export03/data/opt/venv/lib/python3.8/site-packages/nilearn/glm/first_level/experimental_paradigm.py:89: UserWarning: Unexpected column `fixation` in events data will be ignored.
  warnings.warn((&#34;Unexpected column `{}` in events &#34;
/export03/data/opt/venv/lib/python3.8/site-packages/nilearn/glm/first_level/experimental_paradigm.py:89: UserWarning: Unexpected column `fixation_dur` in events data will be ignored.
  warnings.warn((&#34;Unexpected column `{}` in events &#34;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_8_2.png" src="../_images/tutorials_MRI-3T-taskfMRI_8_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define contrasts of interest</span>
<span class="c1"># nibabel expects contrasts to be defined as a dictionary. Here, we first make a dictionary of basic contrasts for each column of our design matrix (1 for that column, 0 for all others)</span>

<span class="n">contrast_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">basic_contrasts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">column</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>

<span class="c1"># now we define actual contrasts of interest for each trial type, without subtracting any other trial type (i.e. uncorrected)</span>
<span class="n">contrasts</span> <span class="o">=</span> <span class="p">{</span>
<span class="s1">&#39;patternseparation_uncorrected&#39;</span><span class="p">:</span> <span class="p">(</span>
    <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar_derivative&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar_dispersion&#39;</span><span class="p">]),</span>
<span class="s1">&#39;patterncompletion_uncorrected&#39;</span><span class="p">:</span> <span class="p">(</span>
    <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_derivative&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_dispersion&#39;</span><span class="p">]),</span>
<span class="s1">&#39;noveltydetection_uncorrected&#39;</span><span class="p">:</span> <span class="p">(</span>
    <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew_derivative&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew_dispersion&#39;</span><span class="p">]),</span>
<span class="c1"># now we will subtract trials where the subject &quot;failed&quot; the trial type of interest</span>
<span class="s1">&#39;patternseparation&#39;</span><span class="p">:</span> <span class="p">(</span>
    <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarnew&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar_derivative&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarnew_derivative&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar_dispersion&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarnew_dispersion&#39;</span><span class="p">]),</span>
<span class="s1">&#39;patterncompletion&#39;</span><span class="p">:</span> <span class="p">(</span>
    <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_derivative&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew_derivative&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_dispersion&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew_dispersion&#39;</span><span class="p">]),</span>
<span class="s1">&#39;noveltydetection&#39;</span><span class="p">:</span> <span class="p">(</span>
    <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew_derivative&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_derivative&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew_derivative&#39;</span><span class="p">]</span>
    <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew_dispersion&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_dispersion&#39;</span><span class="p">]</span>
    <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew_dispersion&#39;</span><span class="p">])}</span>

<span class="n">contrasts</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;patternseparation_uncorrected&#39;: array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0., 1., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]),
 &#39;patterncompletion_uncorrected&#39;: array([0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 1., 1., 0., 0., 0., 0., 0.,
        0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]),
 &#39;noveltydetection_uncorrected&#39;: array([1., 1., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
        0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.]),
 &#39;patternseparation&#39;: array([ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0., -1., -1., -1.,  0.,  0.,  0.,  1.,  1.,  1.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.]),
 &#39;patterncompletion&#39;: array([ 0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  1.,  1.,  1.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
         0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        -1., -1., -1.,  0.,  0.,  0.]),
 &#39;noveltydetection&#39;: array([ 1. ,  1. ,  1. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. , -0.5, -0.5,
        -0.5,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,
         0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,  0. ,
         0. ,  0. ,  0. ,  0. ,  0. ,  0. , -0.5, -0.5, -0.5,  0. ,  0. ,
         0. ])}
</pre></div></div>
</div>
<p>Now we’ll fit the actual data to the design matrix and run our contrasts of interest!</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the neocortical timeseries and parcellate to schaefer 400 space</span>
<span class="n">fmri_img_neo</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-MST2_acq-AP_bold/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_surf-fsLR-32k_desc-timeseries_clean.shape.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">neo_ts_parc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">fmri_img_neo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">neo_ts_parc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmri_img_neo</span><span class="p">[:,</span> <span class="n">parc</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># fit the design matrix to the data</span>
<span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span> <span class="o">=</span> <span class="n">run_glm</span><span class="p">(</span><span class="n">neo_ts_parc</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># run contrasts of interest</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="c1"># Compute contrast-related statistics</span>
    <span class="n">contrast</span> <span class="o">=</span> <span class="n">compute_contrast</span><span class="p">(</span><span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">,</span>
                                <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
    <span class="c1"># We present the Z-transform of the t map</span>
    <span class="n">z_score</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>

    <span class="c1">#create and save gifti images</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
        <span class="n">gii</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]]))</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gii</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-schaefer-400_task-</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrast_id</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot neocortical results (from the last iteration above. That is - noveltydetection for the right hemisphere)</span>
<span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">c69_inf_lh</span><span class="o">.</span><span class="n">n_points</span> <span class="o">+</span> <span class="n">c69_inf_rh</span><span class="o">.</span><span class="n">n_points</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="p">):</span>
        <span class="n">mc</span><span class="p">[</span><span class="n">parc</span><span class="o">==</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">nP</span><span class="p">))]</span> <span class="o">=</span> <span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]][</span><span class="n">i</span><span class="p">]</span>
<span class="n">plot_hemispheres</span><span class="p">(</span> <span class="n">c69_inf_lh</span><span class="p">,</span>  <span class="n">c69_inf_rh</span><span class="p">,</span><span class="n">array_name</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span> <span class="n">color_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nan_color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_12_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_12_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># same as above, but for hippocampus</span>

<span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="n">cdata_hipp</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/MST2/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-hipp_MST2_smooth-1mm.func.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># fit the design matrix to the data</span>
        <span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span> <span class="o">=</span> <span class="n">run_glm</span><span class="p">(</span><span class="n">cdata_hipp</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># run contrasts of interest</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># Compute contrast-related statistics</span>
            <span class="n">contrast</span> <span class="o">=</span> <span class="n">compute_contrast</span><span class="p">(</span><span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">,</span>
                                        <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
            <span class="c1"># We present the Z-transform of the t map</span>
            <span class="n">z_score</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>

            <span class="c1">#create and save gifti images</span>
            <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
                <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
                <span class="n">gii</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]]))</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gii</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_task-</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrast_id</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot hippocampal results (from the last iteration above. That is - noveltydetection for the right hemisphere)</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">z_score</span><span class="p">,</span> <span class="n">den</span><span class="o">=</span><span class="s1">&#39;2mm&#39;</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">color_range</span><span class="o">=</span><span class="s1">&#39;sym&#39;</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_14_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_14_0.png" />
</div>
</div>
<p>Now that we’ve run through a full example for one subject, we’ll loop through all subjects and save the data:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#list all possible combination of correct answer(target) and subject response</span>
<span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;oldold&#39;</span><span class="p">,</span> <span class="s1">&#39;similarsimilar&#39;</span><span class="p">,</span> <span class="s1">&#39;newnew&#39;</span><span class="p">,</span> <span class="s1">&#39;oldsimilar&#39;</span><span class="p">,</span> <span class="s1">&#39;oldnew&#39;</span><span class="p">,</span> <span class="s1">&#39;similarold&#39;</span><span class="p">,</span> <span class="s1">&#39;similarnew&#39;</span><span class="p">,</span> <span class="s1">&#39;newold&#39;</span><span class="p">,</span> <span class="s1">&#39;newsimilar&#39;</span><span class="p">]</span>
<span class="n">current_task</span><span class="o">=</span><span class="s1">&#39;MST2&#39;</span>
<span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>

    <span class="c1"># load in regressors of no interest generated by micapipe</span>
    <span class="n">motion_reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-MST2_acq-AP_bold/volumetric/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_space-func_desc-se.1D&#39;</span><span class="p">)</span>
    <span class="c1"># Specify the timing of fmri frames</span>
    <span class="n">frame_times</span> <span class="o">=</span> <span class="n">TR</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">motion_reg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">slice_time_ref</span><span class="p">)</span>

    <span class="c1">### create design matrix ###</span>

    <span class="c1"># Load event files</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_raw</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_task-MST2_events.tsv&#39;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">events</span><span class="p">[[</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">,</span><span class="s1">&#39;event_1_duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_2_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_3_onset&#39;</span><span class="p">,</span><span class="s1">&#39;response_time&#39;</span><span class="p">]]</span>
    <span class="c1"># Recode events to have easy-to-read names</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation&#39;</span><span class="p">,</span> <span class="s1">&#39;event_1_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation_dur&#39;</span><span class="p">,</span><span class="s1">&#39;event_2_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_3_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;keypress&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Combine response and condition to get all possible combinations</span>
    <span class="n">true_con</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">events</span><span class="p">[</span><span class="s2">&quot;subject response&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">true_con</span>

    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">make_first_level_design_matrix</span><span class="p">(</span><span class="n">frame_times</span><span class="p">,</span>
                                                  <span class="n">events</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                                                  <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative + dispersion&#39;</span><span class="p">,</span>
                                                  <span class="n">add_regs</span><span class="o">=</span><span class="n">motion_reg</span><span class="p">)</span>

    <span class="c1"># in some cases, there are no trials of a certain type (eg. someone never pressed &quot;new&quot; to and &quot;old&quot; stimulus.</span>
    <span class="c1"># in this case add extra columns to the design matrix with all 0s</span>
    <span class="c1"># this will help us look at all trial types later</span>
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Create columns for condition, its derivatives, and dispersion</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">_derivative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">_dispersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">### define contrasts of interest ###</span>

    <span class="n">contrast_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">basic_contrasts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">column</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>

    <span class="c1"># now we define actual contrasts of interest for each trial type, without subtracting any other trial type (i.e. uncorrected)</span>
    <span class="n">contrasts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;patternseparation_uncorrected&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar_derivative&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar_dispersion&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;patterncompletion_uncorrected&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_derivative&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_dispersion&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;noveltydetection_uncorrected&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew_derivative&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew_dispersion&#39;</span><span class="p">]),</span>
    <span class="c1"># now we will subtract trials where the subject &quot;failed&quot; the trial type of interest</span>
    <span class="s1">&#39;patternseparation&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarnew&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar_derivative&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarnew_derivative&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarsimilar_dispersion&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;similarnew_dispersion&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;patterncompletion&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_derivative&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew_derivative&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_dispersion&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew_dispersion&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;noveltydetection&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew_derivative&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_derivative&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew_derivative&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;newnew_dispersion&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldsimilar_dispersion&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;oldnew_dispersion&#39;</span><span class="p">])}</span>

    <span class="c1">### fit the data ###</span>

    <span class="c1"># Load the neocortical timeseries and parcellate to schaefer 400 space</span>
    <span class="n">fmri_img_neo</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-MST2_acq-AP_bold/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_surf-fsLR-32k_desc-timeseries_clean.shape.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">neo_ts_parc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">fmri_img_neo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">neo_ts_parc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmri_img_neo</span><span class="p">[:,</span> <span class="n">parc</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span> <span class="o">=</span> <span class="n">run_glm</span><span class="p">(</span><span class="n">neo_ts_parc</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># run contrasts of interest</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># Compute contrast-related statistics</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="n">compute_contrast</span><span class="p">(</span><span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">,</span>
                                    <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
        <span class="c1"># We present the Z-transform of the t map</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>

        <span class="c1">#create and save gifti images</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
            <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
            <span class="n">gii</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]]))</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gii</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-schaefer-400_task-</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrast_id</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>

    <span class="c1"># same as above, but for hippocampus</span>

    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">cdata_hipp</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/MST2/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-hipp_MST2_smooth-1mm.func.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

            <span class="c1"># fit the design matrix to the data</span>
            <span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span> <span class="o">=</span> <span class="n">run_glm</span><span class="p">(</span><span class="n">cdata_hipp</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="c1"># run contrasts of interest</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Compute contrast-related statistics</span>
                <span class="n">contrast</span> <span class="o">=</span> <span class="n">compute_contrast</span><span class="p">(</span><span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">,</span>
                                            <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
                <span class="c1"># We present the Z-transform of the t map</span>
                <span class="n">z_score</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>

                <span class="c1">#create and save gifti images</span>
                <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
                    <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
                    <span class="n">gii</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]]))</span>
                    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gii</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_task-</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrast_id</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="1.2)-Group-averaging-and-significance/consistency-testing">
<h2>1.2) Group-averaging and significance/consistency testing<a class="headerlink" href="#1.2)-Group-averaging-and-significance/consistency-testing" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#compute average across subjects for each contrasts and plot hippocampal findings</span>
<span class="n">contrastnames_patternsep2</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">contrasts_patternsep2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nV</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hemis</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrast_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">):</span>
                <span class="n">contrast_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/MST2/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_task-MST2_contrast-</span><span class="si">{</span><span class="n">contrast_name</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span>
                <span class="n">contrasts_patternsep2</span><span class="p">[</span><span class="n">iV</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_patternsep2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">den</span><span class="o">=</span><span class="s1">&#39;2mm&#39;</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">color_range</span><span class="o">=</span><span class="s1">&#39;sym&#39;</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/export03/data/opt/venv/lib/python3.8/site-packages/brainspace/plotting/base.py:287: UserWarning: Interactive mode requires &#39;panel&#39;. Setting &#39;interactive=False&#39;
  warnings.warn(&#34;Interactive mode requires &#39;panel&#39;. &#34;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_19_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_19_1.png" />
</div>
</div>
<p><strong>significance testing</strong></p>
<p>We won’t go into detail here, but this gives a basic idea of (uncorrected) significance values. Ideally, some cluster correction should be applied</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_1samp</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">ttest_1samp</span><span class="p">(</span><span class="n">contrasts_patternsep2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nV</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)),</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">tmap</span><span class="p">,</span> <span class="n">den</span><span class="o">=</span><span class="s1">&#39;2mm&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">color_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_21_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_21_0.png" />
</div>
</div>
<p><strong>Additional consistency checks</strong></p>
<p>Rather than significance, we can also check consistency between subject results</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sdfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">):</span>
        <span class="n">cdat</span> <span class="o">=</span> <span class="n">contrasts_patternsep2</span><span class="p">[:,</span><span class="n">h</span><span class="p">,:,</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nV</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">corr</span><span class="p">[:,:,</span><span class="n">h</span><span class="p">,</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">fcorr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[:,:,</span><span class="n">h</span><span class="p">,</span><span class="n">f</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">fcorr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fcorr</span><span class="p">)</span>
        <span class="n">mfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
        <span class="n">sdfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Ttest_1sampResult(statistic=8.131151229499595, pvalue=6.04322441312396e-16)
Ttest_1sampResult(statistic=1.363577810547197, pvalue=0.17281415626269864)
Ttest_1sampResult(statistic=7.303670529693287, pvalue=3.4889664571640743e-13)
Ttest_1sampResult(statistic=1.8870055398040273, pvalue=0.0592467512150204)
Ttest_1sampResult(statistic=0.5960190493982473, pvalue=0.5512041478784316)
Ttest_1sampResult(statistic=3.080369254500647, pvalue=0.0020843689241653303)
Ttest_1sampResult(statistic=6.742503182407484, pvalue=1.8436025081957323e-11)
Ttest_1sampResult(statistic=1.3213936432198694, pvalue=0.18648210464974158)
Ttest_1sampResult(statistic=4.48349257894886, pvalue=7.591531266935211e-06)
Ttest_1sampResult(statistic=1.2144603328144792, pvalue=0.22465836124383068)
Ttest_1sampResult(statistic=0.000554492664403062, pvalue=0.9995576131626948)
Ttest_1sampResult(statistic=2.880721728081016, pvalue=0.003993087634010751)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_23_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_23_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[138]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xnames</span> <span class="o">=</span> <span class="n">contrastnames_patternsep2</span> <span class="o">+</span> <span class="n">contrastnames_patternsep2</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sdfcorr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">xnames</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[138]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.lines.Line2D at 0x7f0dcc72cd00&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_24_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_24_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#save the average maps</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="n">contrastnames_patternsep2</span><span class="p">:</span>
            <span class="n">contrast_idx</span> <span class="o">=</span> <span class="n">cname</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>
            <span class="n">cdat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_patternsep2</span><span class="p">[</span><span class="n">iV</span><span class="p">[</span><span class="n">l</span><span class="p">],</span><span class="n">h</span><span class="p">,:,</span><span class="n">contrast_idx</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">data_array</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cdat</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
            <span class="n">image</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../maps/HippoMaps-initializationMaps/Dataset-MICs/MRI-3T-MST2_average-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">cname</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="1.3)-Consider-neocortical-results">
<h2>1.3) Consider neocortical results<a class="headerlink" href="#1.3)-Consider-neocortical-results" title="Permalink to this heading"></a></h2>
<p>All the same as above, but with neocortical surfaces (and stacking left+right hemispheres)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[97]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">contrasts_patternsep2_neo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nP</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hemis</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrast_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">):</span>
            <span class="n">contrast_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/MST2/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-schaefer-400_task-MST2_contrast-</span><span class="si">{</span><span class="n">contrast_name</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span>
            <span class="n">contrasts_patternsep2_neo</span><span class="p">[:,</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[116]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">c69_inf_lh</span><span class="o">.</span><span class="n">n_points</span> <span class="o">+</span> <span class="n">c69_inf_rh</span><span class="o">.</span><span class="n">n_points</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrast_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">):</span>
            <span class="n">mc</span><span class="p">[</span><span class="n">parc</span><span class="o">==</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">nP</span><span class="p">)),</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_patternsep2_neo</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="n">i</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>

<span class="n">plot_hemispheres</span><span class="p">(</span><span class="n">c69_inf_lh</span><span class="p">,</span> <span class="n">c69_inf_rh</span><span class="p">,</span><span class="n">array_name</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)),</span>
                 <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="mi">200</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)),</span> <span class="n">color_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nan_color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[116]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_28_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_28_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[117]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sdfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">):</span>
    <span class="n">cdat</span> <span class="o">=</span> <span class="n">contrasts_patternsep2_neo</span><span class="p">[:,:,:,</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nP</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">corr</span><span class="p">[:,:,</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">fcorr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[:,:,</span><span class="n">f</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">fcorr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fcorr</span><span class="p">)</span>
    <span class="n">mfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
    <span class="n">sdfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Ttest_1sampResult(statistic=125.44587709572133, pvalue=0.0)
Ttest_1sampResult(statistic=74.74538598254394, pvalue=0.0)
Ttest_1sampResult(statistic=159.3452219200208, pvalue=0.0)
Ttest_1sampResult(statistic=31.226919970854308, pvalue=1.1110902175829445e-206)
Ttest_1sampResult(statistic=13.57098750722382, pvalue=1.1414292911457831e-41)
Ttest_1sampResult(statistic=61.59369873800046, pvalue=0.0)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_29_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_29_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[118]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xnames</span> <span class="o">=</span> <span class="n">contrastnames_patternsep2</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sdfcorr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_patternsep2</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">xnames</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="c1">#plt.ylim([0,.9]);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[118]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.lines.Line2D at 0x7f2e1fd43a30&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_30_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_30_1.png" />
</div>
</div>
</section>
<section id="1.4)-Compare-to-previously-mapped-features">
<h2>1.4) Compare to previously mapped features<a class="headerlink" href="#1.4)-Compare-to-previously-mapped-features" title="Permalink to this heading"></a></h2>
<p>In HippoMaps, we present a high-order space of all features correlated with a continuous anterior-posterior axis by a discrete proximal-distal subfields. Here, we reload that space to find where the present maps fall, and which other mapped features they are most similar to</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># here we look only at the pattern separation and novelty conditions</span>
<span class="n">feats_to_examine</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
<span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_patternsep2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))[:,</span><span class="n">feats_to_examine</span><span class="p">]</span>
<span class="n">topFeatures</span><span class="p">,</span> <span class="n">topR</span><span class="p">,</span> <span class="n">topP</span><span class="p">,</span> <span class="n">APcorr</span><span class="p">,</span> <span class="n">Subfscorr</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">contextualize2D</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="n">nperm</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span> <span class="c1"># ideally nperm should be 10000</span>

<span class="nb">print</span><span class="p">(</span><span class="n">topFeatures</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">topR</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">topP</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/export03/data/opt/venv/lib/python3.8/site-packages/numpy/lib/function_base.py:2691: RuntimeWarning: invalid value encountered in true_divide
  c /= stddev[:, None]
/export03/data/opt/venv/lib/python3.8/site-packages/numpy/lib/function_base.py:2692: RuntimeWarning: invalid value encountered in true_divide
  c /= stddev[None, :]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[&#39;histology-thickness&#39; &#39;MRI-3T-rsfMRI-avgFCneocort&#39;
  &#39;histology-curvature&#39;]
 [&#39;iEEG-BandPower-beta&#39; &#39;iEEG-BandPower-gamma&#39; &#39;iEEG-BandPower-theta&#39;]]
[[ 0.65634844  0.60399173 -0.56773163]
 [-0.6378841  -0.5906666   0.54140302]]
[[0.    0.    0.   ]
 [0.    0.001 0.004]]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_32_2.png" src="../_images/tutorials_MRI-3T-taskfMRI_32_2.png" />
</div>
</div>
</section>
<section id="2)-Episodic-Retrieval">
<h2>2) Episodic Retrieval<a class="headerlink" href="#2)-Episodic-Retrieval" title="Permalink to this heading"></a></h2>
</section>
<section id="2.1)-GLM-fit">
<h2>2.1) GLM fit<a class="headerlink" href="#2.1)-GLM-fit" title="Permalink to this heading"></a></h2>
<p>This section is very similar to the above, but with different input data, conditions, and contrasts. We also don’t walk through one subject, but rather run all subjects together</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;remembered&#39;</span><span class="p">,</span> <span class="s1">&#39;forgotten&#39;</span><span class="p">]</span>
<span class="n">current_task</span><span class="o">=</span><span class="s1">&#39;retrieval&#39;</span>
<span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">:</span>
    <span class="c1"># Specify the timing of fmri frames from one example</span>
    <span class="n">motion_reg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-retrieval_acq-AP_bold/volumetric/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_space-func_desc-se.1D&#39;</span><span class="p">)</span>
    <span class="n">frame_times</span> <span class="o">=</span> <span class="n">TR</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">motion_reg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">slice_time_ref</span><span class="p">)</span>

    <span class="c1">### create design matrix ###</span>

    <span class="c1"># Load event files</span>
    <span class="n">events_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_raw</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_task-retrieval_events.tsv&#39;</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">events_file</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">events</span><span class="p">[[</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">,</span><span class="s1">&#39;event_1_duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_2_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_3_onset&#39;</span><span class="p">,</span><span class="s1">&#39;response_time&#39;</span><span class="p">,</span><span class="s1">&#39;subject_response&#39;</span><span class="p">,</span><span class="s1">&#39;prime&#39;</span><span class="p">,</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span>
    <span class="c1"># Recode events to have easy-to-read names</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation&#39;</span><span class="p">,</span> <span class="s1">&#39;event_1_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation_dur&#39;</span><span class="p">,</span><span class="s1">&#39;event_2_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_3_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;keypress&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;remembered&#39;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_response&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;forgotten&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">make_first_level_design_matrix</span><span class="p">(</span><span class="n">frame_times</span><span class="p">,</span>
                                                  <span class="n">events</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
                                                  <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative + dispersion&#39;</span><span class="p">,</span>
                                                  <span class="n">add_regs</span><span class="o">=</span><span class="n">motion_reg</span>
                                                  <span class="p">)</span>
    <span class="c1"># in case of some trial types missing, add extras with all 0sL</span>
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># Create columns for condition, its derivatives, and dispersion</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">_derivative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">_dispersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


    <span class="c1">### define contrasts of interest ###</span>

    <span class="n">contrast_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">basic_contrasts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">column</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>

    <span class="n">contrasts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;retrieval_uncorrected&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;remembered&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;remembered_derivative&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;remembered_dispersion&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;retrieval_corrected&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;remembered&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;forgotten&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;remembered_derivative&#39;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;forgotten_derivative&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;remembered_dispersion&#39;</span><span class="p">]</span>
        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;forgotten_dispersion&#39;</span><span class="p">])}</span>


    <span class="c1">### fit the data ###</span>

    <span class="c1"># Load the neocortical timeseries and parcellate to schaefer 400 space</span>
    <span class="n">fmri_img_neo</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-MST2_acq-AP_bold/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_surf-fsLR-32k_desc-timeseries_clean.shape.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">neo_ts_parc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">fmri_img_neo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">neo_ts_parc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmri_img_neo</span><span class="p">[:,</span> <span class="n">parc</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span> <span class="o">=</span> <span class="n">run_glm</span><span class="p">(</span><span class="n">neo_ts_parc</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># run contrasts of interest</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># Compute contrast-related statistics</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="n">compute_contrast</span><span class="p">(</span><span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">,</span>
                                    <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
        <span class="c1"># We present the Z-transform of the t map</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>

        <span class="c1">#create and save gifti images</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
            <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
            <span class="n">gii</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]]))</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gii</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-schaefer-400_task-</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrast_id</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>

    <span class="c1"># same as above, but for hippocampus</span>

    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">cdata_hipp</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/MST2/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-hipp_MST2_smooth-1mm.func.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

            <span class="c1"># fit the design matrix to the data</span>
            <span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span> <span class="o">=</span> <span class="n">run_glm</span><span class="p">(</span><span class="n">cdata_hipp</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="c1"># run contrasts of interest</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Compute contrast-related statistics</span>
                <span class="n">contrast</span> <span class="o">=</span> <span class="n">compute_contrast</span><span class="p">(</span><span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">,</span>
                                            <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
                <span class="c1"># We present the Z-transform of the t map</span>
                <span class="n">z_score</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>

                <span class="c1">#create and save gifti images</span>
                <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
                    <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
                    <span class="n">gii</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]]))</span>
                    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gii</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_task-</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrast_id</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot design matrix of the last subject</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Design Matrix for Subject </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Regressors&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Time Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Regressor Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_36_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_36_0.png" />
</div>
</div>
</section>
<section id="2.2)-Group-averaging-and-significance/consistency-testing">
<h2>2.2) Group-averaging and significance/consistency testing<a class="headerlink" href="#2.2)-Group-averaging-and-significance/consistency-testing" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[96]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#compute average across subjects for each contrasts and plot hippocampal findings</span>
<span class="n">contrastnames_epiretrieve</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">contrasts_retrieval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nV</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrast_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">):</span>
                <span class="n">contrast_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/retrieval/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_task-retrieval_contrast-</span><span class="si">{</span><span class="n">contrast_name</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span>
                <span class="n">contrasts_retrieval</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[247]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_retrieval</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">den</span><span class="o">=</span><span class="s1">&#39;2mm&#39;</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">color_range</span><span class="o">=</span><span class="s1">&#39;sym&#39;</span><span class="p">,</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[247]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_39_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_39_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[256]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_1samp</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">ttest_1samp</span><span class="p">(</span><span class="n">contrasts_retrieval</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nV</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">))),</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">tmap</span><span class="p">,</span> <span class="n">den</span><span class="o">=</span><span class="s1">&#39;2mm&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">color_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[256]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_40_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_40_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#save the average maps</span>
<span class="c1"># Select the corrected contrasts only</span>
<span class="n">selected_contrastnames</span> <span class="o">=</span> <span class="n">contrastnames_epiretrieve</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">contrastname_epiretrieve</span> <span class="ow">in</span> <span class="n">selected_contrastnames</span><span class="p">:</span>
            <span class="n">contrast_idx</span> <span class="o">=</span> <span class="n">contrastnames_epiretrieve</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">contrastname_epiretrieve</span><span class="p">)</span>
            <span class="n">cdat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_retrieval</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">],</span><span class="n">h</span><span class="p">,:,</span><span class="n">contrast_idx</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">data_array</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cdat</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
            <span class="n">image</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../maps/HippoMaps-initializationMaps/Dataset-MICs/MRI-3T-epiretrieve_average-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrastname_epiretrieve</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[139]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sdfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">):</span>
        <span class="n">cdat</span> <span class="o">=</span> <span class="n">contrasts_retrieval</span><span class="p">[:,</span><span class="n">h</span><span class="p">,:,</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nV</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">corr</span><span class="p">[:,:,</span><span class="n">h</span><span class="p">,</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">fcorr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[:,:,</span><span class="n">h</span><span class="p">,</span><span class="n">f</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">fcorr</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">))</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fcorr</span><span class="p">)</span>
        <span class="n">mfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
        <span class="n">sdfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_42_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_42_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[140]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xnames</span> <span class="o">=</span> <span class="n">contrastnames_epiretrieve</span> <span class="o">+</span> <span class="n">contrastnames_epiretrieve</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sdfcorr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">xnames</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="c1">#plt.ylim([0,.9]);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[140]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.lines.Line2D at 0x7f0dcd3b1af0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_43_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_43_1.png" />
</div>
</div>
</section>
<section id="2.3)-Consider-the-neocortex">
<h2>2.3) Consider the neocortex<a class="headerlink" href="#2.3)-Consider-the-neocortex" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#compute average across subjects for each contrasts and plot neocortical findings</span>
<span class="n">contrasts_retrieval_neo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nP</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hemis</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrast_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">):</span>
            <span class="n">contrast_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/retrieval/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-schaefer-400_task-retrieval_contrast-</span><span class="si">{</span><span class="n">contrast_name</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span>
            <span class="n">contrasts_retrieval_neo</span><span class="p">[:,</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[226]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">c69_inf_lh</span><span class="o">.</span><span class="n">n_points</span> <span class="o">+</span> <span class="n">c69_inf_rh</span><span class="o">.</span><span class="n">n_points</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrast_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">):</span>
            <span class="n">mc</span><span class="p">[</span><span class="n">parc</span><span class="o">==</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">nP</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_retrieval_neo</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="n">i</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">plot_hemispheres</span><span class="p">(</span> <span class="n">c69_inf_lh</span><span class="p">,</span>  <span class="n">c69_inf_rh</span><span class="p">,</span><span class="n">array_name</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)),</span>
                 <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="mi">200</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)),</span> <span class="n">color_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nan_color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[226]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_46_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_46_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[101]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sdfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">):</span>
    <span class="n">cdat</span> <span class="o">=</span> <span class="n">contrasts_retrieval_neo</span><span class="p">[:,:,:,</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nP</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">corr</span><span class="p">[:,:,</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">fcorr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[:,:,</span><span class="n">f</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fcorr</span><span class="p">)</span>
    <span class="n">mfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
    <span class="n">sdfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_47_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_47_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[102]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xnames</span> <span class="o">=</span> <span class="n">contrastnames_epiretrieve</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sdfcorr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiretrieve</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">xnames</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="c1">#plt.ylim([0,.9]);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[102]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.lines.Line2D at 0x7f0dcb802490&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_48_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_48_1.png" />
</div>
</div>
</section>
<section id="3)-Episodic-encoding--subsequent-memory">
<h2>3) Episodic encoding -subsequent memory<a class="headerlink" href="#3)-Episodic-encoding--subsequent-memory" title="Permalink to this heading"></a></h2>
</section>
<section id="3.1)-GLM-fit">
<h2>3.1) GLM fit<a class="headerlink" href="#3.1)-GLM-fit" title="Permalink to this heading"></a></h2>
<p>Again, this section is very similar to the above, but with different input data, conditions, and contrasts. We also don’t walk through one subject, but rather run all subjects together</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[104]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">,</span> <span class="s1">&#39;incorrect&#39;</span><span class="p">]</span>
<span class="n">current_task</span><span class="o">=</span><span class="s1">&#39;encoding&#39;</span>
<span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="c1"># Specify the timing of fmri frames from one example</span>
    <span class="n">motion_reg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-encoding_acq-AP_bold/volumetric/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_space-func_desc-se.1D&#39;</span><span class="p">)</span>
    <span class="n">frame_times</span> <span class="o">=</span> <span class="n">TR</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">motion_reg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">slice_time_ref</span><span class="p">)</span>

    <span class="c1">### create design matrix ###</span>

    <span class="c1"># This is slightly more complicated now since we need to look up which stimuli were actually subsequently remmebered by matching their IDs</span>

    <span class="c1"># Load encoding file</span>
    <span class="n">encoding_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_raw</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_task-encoding_events.tsv&#39;</span>
    <span class="n">df_encode</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">encoding_file</span><span class="p">)</span>
    <span class="n">df_encode</span><span class="o">=</span> <span class="n">df_encode</span><span class="p">[[</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">,</span><span class="s1">&#39;event_1_duration&#39;</span><span class="p">,</span><span class="s1">&#39;event_2_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;stim_duration&#39;</span><span class="p">,</span><span class="s1">&#39;stim_1&#39;</span><span class="p">,</span><span class="s1">&#39;stim_2&#39;</span><span class="p">]]</span>
    <span class="c1"># Recode events to have easy-to-read names</span>
    <span class="n">df_encode</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation&#39;</span><span class="p">,</span> <span class="s1">&#39;event_1_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation_dur&#39;</span><span class="p">,</span><span class="s1">&#39;event_2_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;stim_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;duration&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Load retrieval file</span>
    <span class="n">retrieval_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_raw</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_task-retrieval_events.tsv&#39;</span>
    <span class="n">df_retrieve</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">retrieval_file</span><span class="p">)</span>
    <span class="n">df_retrieve</span><span class="o">=</span><span class="n">df_retrieve</span><span class="p">[[</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_1_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;prime&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="s1">&#39;event_3_onset&#39;</span><span class="p">,</span><span class="s1">&#39;subject_response&#39;</span><span class="p">]]</span>
    <span class="c1"># Recode events to have easy-to-read names</span>
    <span class="n">df_retrieve</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;event_1_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation&#39;</span><span class="p">,</span> <span class="s1">&#39;event_1_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;fixation_dur&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;onset&#39;</span><span class="p">,</span> <span class="s1">&#39;event_2_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;event_3_onset&#39;</span><span class="p">:</span> <span class="s1">&#39;keypress&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_retrieve</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">df_retrieve</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_retrieve</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="s1">&#39;correct&#39;</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;subject_response&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;incorrect&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;onset&#39;</span><span class="p">,</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span><span class="s1">&#39;prime&#39;</span><span class="p">,</span><span class="s1">&#39;target&#39;</span><span class="p">,</span><span class="s1">&#39;trial_type&#39;</span><span class="p">])</span>
    <span class="c1"># Dictionary to keep track of matched rows in df_retrieve</span>
    <span class="n">matched_rows_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Iterate through rows in encoding data</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row_encode</span> <span class="ow">in</span> <span class="n">df_encode</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">stim_1</span> <span class="o">=</span> <span class="n">row_encode</span><span class="p">[</span><span class="s1">&#39;stim_1&#39;</span><span class="p">]</span>
        <span class="n">stim_2</span> <span class="o">=</span> <span class="n">row_encode</span><span class="p">[</span><span class="s1">&#39;stim_2&#39;</span><span class="p">]</span>

        <span class="c1"># Check if this pair has already been matched</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stim_1</span><span class="p">,</span> <span class="n">stim_2</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matched_rows_dict</span><span class="p">:</span>
            <span class="c1"># Match rows in retrieval data based on stim_1 and stim_2</span>
            <span class="n">match_rows</span> <span class="o">=</span> <span class="n">df_retrieve</span><span class="p">[(</span><span class="n">df_retrieve</span><span class="p">[</span><span class="s1">&#39;prime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stim_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_retrieve</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stim_2</span><span class="p">)]</span>

            <span class="c1"># If there is exactly one match, append the data to the design matrix</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">matched_row</span> <span class="o">=</span> <span class="n">match_rows</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">row_encode</span><span class="p">[</span><span class="s1">&#39;onset&#39;</span><span class="p">],</span>
                                 <span class="n">row_encode</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">],</span>
                                 <span class="n">matched_row</span><span class="p">[</span><span class="s1">&#39;prime&#39;</span><span class="p">],</span>
                                 <span class="n">matched_row</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">],</span>
                                 <span class="n">matched_row</span><span class="p">[</span><span class="s1">&#39;trial_type&#39;</span><span class="p">]]</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

                <span class="c1"># Update the matched_rows_dict to mark this pair as matched</span>
                <span class="n">matched_rows_dict</span><span class="p">[(</span><span class="n">stim_1</span><span class="p">,</span> <span class="n">stim_2</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If there is no match or multiple matches, mark this pair as unmatched</span>
                <span class="n">matched_rows_dict</span><span class="p">[(</span><span class="n">stim_1</span><span class="p">,</span> <span class="n">stim_2</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">design_matrix</span> <span class="o">=</span> <span class="n">make_first_level_design_matrix</span><span class="p">(</span><span class="n">frame_times</span><span class="p">,</span>
                                      <span class="n">events</span><span class="o">=</span><span class="n">new_df</span><span class="p">,</span>
                                      <span class="n">hrf_model</span><span class="o">=</span><span class="s1">&#39;spm + derivative + dispersion&#39;</span><span class="p">,</span>
                                      <span class="n">add_regs</span><span class="o">=</span><span class="n">motion_reg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">_derivative&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">design_matrix</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">_dispersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">### define contrasts of interest ###</span>

    <span class="n">contrast_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">basic_contrasts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">column</span><span class="p">,</span> <span class="n">contrast_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>

    <span class="n">contrasts</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;subsequent_memory_uncorrected&#39;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;correct_derivative&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;correct_dispersion&#39;</span><span class="p">]),</span>
                    <span class="s1">&#39;subsequent_memory_corrected&#39;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;correct&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;incorrect&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;correct_derivative&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;incorrect_derivative&#39;</span><span class="p">]</span>
                        <span class="o">+</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;correct_dispersion&#39;</span><span class="p">]</span>
                        <span class="o">-</span> <span class="n">basic_contrasts</span><span class="p">[</span><span class="s1">&#39;incorrect_dispersion&#39;</span><span class="p">])}</span>

    <span class="c1">### fit the data ###</span>

    <span class="c1"># Load the neocortical timeseries and parcellate to schaefer 400 space</span>
    <span class="n">fmri_img_neo</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/func/desc-se_task-MST2_acq-AP_bold/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_surf-fsLR-32k_desc-timeseries_clean.shape.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">neo_ts_parc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">fmri_img_neo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">neo_ts_parc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fmri_img_neo</span><span class="p">[:,</span> <span class="n">parc</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span> <span class="o">=</span> <span class="n">run_glm</span><span class="p">(</span><span class="n">neo_ts_parc</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="c1"># run contrasts of interest</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="c1"># Compute contrast-related statistics</span>
        <span class="n">contrast</span> <span class="o">=</span> <span class="n">compute_contrast</span><span class="p">(</span><span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">,</span>
                                    <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
        <span class="c1"># We present the Z-transform of the t map</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>

        <span class="c1">#create and save gifti images</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
            <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
            <span class="n">gii</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]]))</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gii</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-schaefer-400_task-</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrast_id</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>

    <span class="c1"># same as above, but for hippocampus</span>

    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">cdata_hipp</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/MST2/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-hipp_MST2_smooth-1mm.func.gii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

            <span class="c1"># fit the design matrix to the data</span>
            <span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span> <span class="o">=</span> <span class="n">run_glm</span><span class="p">(</span><span class="n">cdata_hipp</span><span class="p">,</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="c1"># run contrasts of interest</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">contrast_id</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="c1"># Compute contrast-related statistics</span>
                <span class="n">contrast</span> <span class="o">=</span> <span class="n">compute_contrast</span><span class="p">(</span><span class="n">labels_</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">contrast_val</span><span class="p">,</span>
                                            <span class="n">contrast_type</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
                <span class="c1"># We present the Z-transform of the t map</span>
                <span class="n">z_score</span> <span class="o">=</span> <span class="n">contrast</span><span class="o">.</span><span class="n">z_score</span><span class="p">()</span>

                <span class="c1">#create and save gifti images</span>
                <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
                    <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
                    <span class="n">gii</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">z_score</span><span class="p">[</span><span class="n">iP</span><span class="p">[</span><span class="n">h</span><span class="p">]]))</span>
                    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">gii</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_task-</span><span class="si">{</span><span class="n">current_task</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrast_id</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[105]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot design matrix of the last subject</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;seismic&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Design Matrix for Subject </span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="n">design_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Regressors&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Time Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Regressor Values&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_52_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_52_0.png" />
</div>
</div>
</section>
<section id="3.2)-Group-averaging-and-significance/consistency-testing">
<h2>3.2) Group-averaging and significance/consistency testing<a class="headerlink" href="#3.2)-Group-averaging-and-significance/consistency-testing" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[107]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#compute average across subjects for each contrasts and plot hippocampal findings</span>
<span class="n">contrastnames_epiencode</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">contrasts</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">contrasts_epiencode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nV</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrastname_epiencode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">):</span>
                <span class="n">contrast_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/encoding/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_task-encoding_contrast-</span><span class="si">{</span><span class="n">contrastname_epiencode</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span>
                <span class="n">contrasts_epiencode</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[249]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_epiencode</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">den</span><span class="o">=</span><span class="s1">&#39;2mm&#39;</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">color_range</span><span class="o">=</span><span class="s1">&#39;sym&#39;</span><span class="p">,</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[249]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_55_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_55_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[257]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_1samp</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">ttest_1samp</span><span class="p">(</span><span class="n">contrasts_epiencode</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nV</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">))),</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">tmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">tmap</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">tmap</span><span class="p">,</span> <span class="n">den</span><span class="o">=</span><span class="s1">&#39;2mm&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">color_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[257]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_56_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_56_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[111]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#save the average maps</span>
<span class="c1"># Select the corrected contrasts only</span>
<span class="n">selected_contrastnames</span> <span class="o">=</span> <span class="n">contrastnames_epiencode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">contrastname_epiencode</span> <span class="ow">in</span> <span class="n">selected_contrastnames</span><span class="p">:</span>
            <span class="n">contrast_idx</span> <span class="o">=</span> <span class="n">contrastnames_epiencode</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">contrastname_epiencode</span><span class="p">)</span>
            <span class="n">cdat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_epiencode</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">l</span><span class="p">],</span><span class="n">h</span><span class="p">,:,</span><span class="n">contrast_idx</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">data_array</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cdat</span><span class="p">)</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
            <span class="n">image</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../maps/HippoMaps-initializationMaps/Dataset-MICs/MRI-3T-epiencode_average-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_den-2mm_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_contrast-</span><span class="si">{</span><span class="n">contrastname_epiencode</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[142]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sdfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">):</span>
        <span class="n">cdat</span> <span class="o">=</span> <span class="n">contrasts_epiencode</span><span class="p">[:,</span><span class="n">h</span><span class="p">,:,</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nV</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">corr</span><span class="p">[:,:,</span><span class="n">h</span><span class="p">,</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">fcorr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[:,:,</span><span class="n">h</span><span class="p">,</span><span class="n">f</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fcorr</span><span class="p">)</span>
        <span class="n">mfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
        <span class="n">sdfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_58_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_58_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[143]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xnames</span> <span class="o">=</span> <span class="n">contrastnames_epiencode</span> <span class="o">+</span> <span class="n">contrastnames_epiencode</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sdfcorr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">xnames</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="c1">#plt.ylim([0,.9]);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[143]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.lines.Line2D at 0x7f0dcac1d400&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_59_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_59_1.png" />
</div>
</div>
</section>
<section id="3.3)-Consider-the-neocortex">
<h2>3.3) Consider the neocortex<a class="headerlink" href="#3.3)-Consider-the-neocortex" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[114]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#compute average across subjects for each contrasts and plot neocortical findings</span>
<span class="n">contrasts_epiencode_neo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nP</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hemis</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrast_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">):</span>
            <span class="n">contrast_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/ses-</span><span class="si">{</span><span class="n">ses</span><span class="si">}</span><span class="s1">/surf/task-fMRI/encoding/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-2mm_label-schaefer-400_task-encoding_contrast-</span><span class="si">{</span><span class="n">contrast_name</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span>
            <span class="n">contrasts_epiencode_neo</span><span class="p">[:,</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">contrast_file</span><span class="p">)</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[228]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">c69_inf_lh</span><span class="o">.</span><span class="n">n_points</span> <span class="o">+</span> <span class="n">c69_inf_rh</span><span class="o">.</span><span class="n">n_points</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nP</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">contrast_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">):</span>
            <span class="n">mc</span><span class="p">[</span><span class="n">parc</span><span class="o">==</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">nP</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">contrasts_epiencode_neo</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="n">i</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
<span class="n">plot_hemispheres</span><span class="p">(</span> <span class="n">c69_inf_lh</span><span class="p">,</span>  <span class="n">c69_inf_rh</span><span class="p">,</span><span class="n">array_name</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)),</span>
                 <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="mi">200</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)),</span> <span class="n">color_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nan_color</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[228]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_62_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_62_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[116]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sdfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">):</span>
    <span class="n">cdat</span> <span class="o">=</span> <span class="n">contrasts_epiencode_neo</span><span class="p">[:,:,:,</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nP</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">corr</span><span class="p">[:,:,</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">fcorr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[:,:,</span><span class="n">f</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fcorr</span><span class="p">)</span>
    <span class="n">mfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
    <span class="n">sdfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_63_0.png" src="../_images/tutorials_MRI-3T-taskfMRI_63_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[117]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xnames</span> <span class="o">=</span> <span class="n">contrastnames_epiencode</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)),</span><span class="n">mfcorr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sdfcorr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contrastnames_epiencode</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">xnames</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="c1">#plt.ylim([0,.9]);</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[117]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.lines.Line2D at 0x7f0dcb82f370&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-3T-taskfMRI_64_1.png" src="../_images/tutorials_MRI-3T-taskfMRI_64_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<script type="application/vnd.jupyter.widget-state+json">
{"state": {}, "version_major": 2, "version_minor": 0}
</script></section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="DimReduct.html" class="btn btn-neutral float-left" title="Dimensionality-Reduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api.html" class="btn btn-neutral float-right" title="Tools Index" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, DeKraker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>