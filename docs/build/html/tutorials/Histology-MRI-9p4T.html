<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Histology-MRI-9p4T &mdash; Hippomaps 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=264bf13b"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MRI-7T-struct" href="MRI-7T-struct.html" />
    <link rel="prev" title="Morphology" href="Morphology.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Hippomaps
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Morphology.html">Morphology</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Histology-MRI-9p4T</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#0)-Map-and-load-volumetric-data-to-surfaces">0) Map and load volumetric data to surfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1)-Load,-plot,-and-preprocess-all-surface-data">1) Load, plot, and preprocess all surface data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2)-Group-average-and-laminar-microstructural-profiles">2) Group average and laminar microstructural profiles</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3)-Summarize-data-according-to-primary-gradients">3) Summarize data according to primary gradients</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="MRI-7T-struct.html">MRI-7T-struct</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-rsfMRI.html">MRI-3T-rsfMRI</a></li>
<li class="toctree-l2"><a class="reference internal" href="iEEG.html">iEEG</a></li>
<li class="toctree-l2"><a class="reference internal" href="DimReduct.html">Dimensionality-Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html">MRI-3T-taskfMRI</a></li>
<li class="toctree-l2"><a class="reference internal" href="TLE-HC.html">Case control atrophy mapping in temporal lobe epilepsy vs healthy controls (TLE-HC)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Tools Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">References &amp; Acknowledgements</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Hippomaps</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Histology-MRI-9p4T</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Histology-MRI-9p4T">
<h1>Histology-MRI-9p4T<a class="headerlink" href="#Histology-MRI-9p4T" title="Permalink to this heading"></a></h1>
<p><strong>Overview</strong></p>
<p>This notebook will examine ex-vivo histology data from the BigBrain, 3D PLI, and AHEAD brain datasets. First wewill look at morphological features in unfolded space</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">hippomaps</span> <span class="k">as</span> <span class="nn">hm</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># locate input data</span>
<span class="n">source_dir</span> <span class="o">=</span> <span class="s1">&#39;../../publication-hippomaps/sourcedata/BIDS_HISTO/&#39;</span>
<span class="n">hippunfold_dir</span> <span class="o">=</span> <span class="s1">&#39;../../publication-hippomaps/hippunfold/HISTO_v1.3.0_100um/hippunfold/&#39;</span>

<span class="c1"># define which subjects and surfaces to examine</span>
<span class="n">subs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bbhist&#39;</span><span class="p">,</span> <span class="s1">&#39;bbhist&#39;</span><span class="p">,</span> <span class="s1">&#39;bbhist2&#39;</span><span class="p">,</span> <span class="s1">&#39;bbhist2&#39;</span><span class="p">,</span> <span class="s1">&#39;pli3d&#39;</span><span class="p">,</span> <span class="s1">&#39;122017&#39;</span><span class="p">,</span> <span class="s1">&#39;122017&#39;</span><span class="p">,</span> <span class="s1">&#39;152017&#39;</span><span class="p">,</span> <span class="s1">&#39;152017&#39;</span><span class="p">]</span>
<span class="n">ses</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">hemis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hipp&#39;</span><span class="p">]</span>
<span class="n">den</span><span class="o">=</span><span class="s1">&#39;unfoldiso&#39;</span>

<span class="c1"># here we will generate multiple depth-wise surfaces</span>
<span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.25</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">depths</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span>  <span class="n">depths</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># get expected number of vertices and their indices</span>
<span class="n">nV</span><span class="p">,</span><span class="n">iV</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_nVertices</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">den</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="0)-Map-and-load-volumetric-data-to-surfaces">
<h2>0) Map and load volumetric data to surfaces<a class="headerlink" href="#0)-Map-and-load-volumetric-data-to-surfaces" title="Permalink to this heading"></a></h2>
<p>As in all tutorials here, this step is OPTIONAL, and provides an example of how data can be mapped to hippocampal surfaces outside of python (using ANTs and/or wb_command). This relies on having the data stored locally, and should be considered example code. This code may differ depending on where/how your data is stored and formatted, and so may require some customization for new projects. For the purposes of this tutorial, we provide a matrix of loaded data at the end, so skip to the next
step.</p>
<p>In this example, we loop through samples (that is, subjects and hemipsheres) and generate surfaces at different depths using the <code class="docutils literal notranslate"><span class="pre">wb_command</span></code> tool. Then, we loop through each modality and sample the data to those surfaces. Finally, we load the data from all surfaces into a single matrix.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create surfaces at various depths</span>
<span class="n">hipp_dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nV</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">)])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;mkdir -p </span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/depths&#39;</span>
    <span class="o">!{</span>cmd<span class="o">}</span>
    <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
        <span class="n">cmd1</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -surface-cortex-layer &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_space-corobl_den-</span><span class="si">{</span><span class="n">den</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_inner.surf.gii &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_space-corobl_den-</span><span class="si">{</span><span class="n">den</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_outer.surf.gii &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1"> &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/depths/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">.surf.gii&#39;</span>
        <span class="o">!{</span>cmd1<span class="o">}</span>
        <span class="n">cmd2</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -volume-to-surface-mapping &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">source_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/anat/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">.nii.gz &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/depths/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">.surf.gii &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/depths/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_intensity-default.shape.gii &#39;</span>\
            <span class="sa">f</span><span class="s1">&#39;-trilinear&#39;</span>
        <span class="o">!{</span>cmd2<span class="o">}</span>
        <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/depths/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_intensity-default.shape.gii&#39;</span><span class="p">)</span>
        <span class="n">hipp_dat</span><span class="p">[:,</span><span class="n">l</span><span class="p">,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">gii</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add extra modalities from AHEAD</span>
<span class="n">ahead_additional_modalities</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;Bieloschowsky-interpolated&#39;</span><span class="p">,</span> <span class="s1">&#39;calbindin-interpolated&#39;</span><span class="p">,</span> <span class="s1">&#39;calretinin-interpolated&#39;</span><span class="p">,</span> <span class="s1">&#39;parvalbumin-interpolated&#39;</span><span class="p">,</span> <span class="s1">&#39;thionin-interpolated&#39;</span><span class="p">,</span> <span class="s1">&#39;MRI-proton-density&#39;</span><span class="p">,</span> <span class="s1">&#39;MRI-quantitative-R1&#39;</span><span class="p">,</span> <span class="s1">&#39;MRI-quantitative-R2star&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">modality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ahead_additional_modalities</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]:</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">hipp_dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">layer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
            <span class="n">cmd2</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -volume-to-surface-mapping &#39;</span>\
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">source_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">/anat/sub-</span><span class="si">{</span><span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s1">.nii.gz &#39;</span>\
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">/surf/depths/sub-</span><span class="si">{</span><span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">.surf.gii &#39;</span>\
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">/surf/depths/sub-</span><span class="si">{</span><span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_intensity-</span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s1">.shape.gii &#39;</span>\
                <span class="sa">f</span><span class="s1">&#39;-enclosing&#39;</span>
            <span class="o">!{</span>cmd2<span class="o">}</span>
            <span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">/surf/depths/sub-</span><span class="si">{</span><span class="n">subs</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">_intensity-</span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
            <span class="n">vol</span><span class="p">[:,</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">gii</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">hipp_dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">hipp_dat</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">vol</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;../checkpoints/struct-HISTO-unproc&quot;</span><span class="p">,</span><span class="n">hipp_dat</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="1)-Load,-plot,-and-preprocess-all-surface-data">
<h2>1) Load, plot, and preprocess all surface data<a class="headerlink" href="#1)-Load,-plot,-and-preprocess-all-surface-data" title="Permalink to this heading"></a></h2>
<p>Here, we use the data already loaded into a large matrix from the previous step). This matrix <code class="docutils literal notranslate"><span class="pre">hipp_dat</span></code> has a shape of (number of vertices nV) x (number of surface depths) x (number of samples OR features)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hipp_dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../checkpoints/struct-HISTO-unproc&quot;</span><span class="p">,</span><span class="n">hipp_dat</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># inspect some example maps. We will plot all data as if it were from a left hemisphere, for simplicity.</span>
<span class="c1"># Note that here, we average across all depths that are within the hippocampal bounds (i.e. depths 0-1)</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">]</span>
<span class="n">cdata</span> <span class="o">=</span> <span class="n">hipp_dat</span><span class="p">[:,:,</span><span class="n">examples</span><span class="p">]</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">cdata</span><span class="p">[:,</span><span class="n">gm</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">den</span><span class="o">=</span><span class="n">den</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">350</span><span class="p">,</span><span class="mi">270</span><span class="p">],</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_8_0.png" src="../_images/tutorials_Histology-MRI-9p4T_8_0.png" />
</div>
</div>
<p><strong>Preprocessing</strong></p>
<p>Clearly these images will need some preprocessing to account for issues like missing data, impofect alignment between AHEAD stains, and imperfect surfaces</p>
<p><strong>Missing data</strong></p>
<p>For this, we will set all background values (sometimes 0, sometimes an integer like 2 or -1) to NaN. Then we will find outliers and also set them to NaN. Then we will dilate the mask of NaNs, because some edge cases are not exactly 0, but are not plausible values either. Then, we will interpolate the NaNs (linear) and extrapolate any remaining values (nearest)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fill_missing</span><span class="p">(</span><span class="n">cdata</span><span class="p">):</span>
    <span class="n">cdata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># any of these values are very likely from background</span>

    <span class="c1"># find LOCAL outliers (smooth the image and then find values that are &gt;4 S.D. from the smoothed version)</span>
    <span class="n">cdata_localOutliers</span> <span class="o">=</span> <span class="n">cdata</span> <span class="o">-</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">cdata</span><span class="p">,[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cdata_localOutliers</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">cdata_localOutliers</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
    <span class="n">cdata</span><span class="p">[</span><span class="n">cdata_localOutliers</span><span class="o">&gt;</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">cdata</span><span class="p">[</span><span class="n">cdata_localOutliers</span><span class="o">&lt;-</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># take edges off missing data too</span>
    <span class="n">cdata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">binary_dilation</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cdata</span><span class="p">),</span> <span class="n">structure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># interpolate NaNs</span>
    <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cdata</span><span class="p">))</span>
    <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cdata</span><span class="p">))</span>
    <span class="n">fill</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">griddata</span><span class="p">(</span><span class="n">good</span><span class="p">,</span> <span class="n">cdata</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">bad</span><span class="p">)</span>
    <span class="n">cdata</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>

    <span class="c1"># extrapolate any values that are still missing</span>
    <span class="n">good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cdata</span><span class="p">))</span>
    <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cdata</span><span class="p">))</span>
    <span class="n">fill</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">griddata</span><span class="p">(</span><span class="n">good</span><span class="p">,</span> <span class="n">cdata</span><span class="p">[</span><span class="n">good</span><span class="p">],</span> <span class="n">bad</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
    <span class="n">cdata</span><span class="p">[</span><span class="n">bad</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span>
    <span class="k">return</span> <span class="n">cdata</span>
</pre></div>
</div>
</div>
<p><strong>Alignment method</strong></p>
<p>Here we develop a tool to depth-wise or laminar align profiles, since the grey matter boundaries may not be perfect. We use only translations, and maximize the correlation between each profile and the average. This can be applied either over the whole image or over image patches, and we will illustrate an example using each.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># view an example set of laminar profiles from the first sample</span>

<span class="n">s</span><span class="o">=</span><span class="mi">0</span>
<span class="n">sub</span> <span class="o">=</span> <span class="n">subs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hipp_dat</span><span class="p">[</span><span class="mi">500</span><span class="p">:</span><span class="mi">1000</span><span class="p">,:,</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7fcea510ac10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_13_1.png" src="../_images/tutorials_Histology-MRI-9p4T_13_1.png" />
</div>
</div>
<p><strong>Note</strong> that the very top and very bottom of the data actually come from outside of our original hippocampal bounds, since surfaces were extrapolated out over these areas.</p>
<p>Notice how in some areas the profiles are raised or lowered. Ths can happen due to imperfect segmentation - sometimes the hippocampal boundaries may have been inadvertently shifted upwards or downwards. In the AHEAD dataset this can also arise because even when segmentation is perfect, the alignment between the different modalities is still off. This is the problem we aim to correct here.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">tdat</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">profile_align</span><span class="p">(</span><span class="n">hipp_dat</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tdat</span><span class="p">[</span><span class="mi">500</span><span class="p">:</span><span class="mi">1000</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7fcea4f64d30&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_15_1.png" src="../_images/tutorials_Histology-MRI-9p4T_15_1.png" />
</div>
</div>
<p>The default profile_align method aligns each profile to a global average of all profiles. This is computationally relatively fast, and robust since it won’t be affected by local “drift” of a segmentation or registration away from the actual hippocampal boundaries. However, it is less precise than a local average seen below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># to apply local averaging of profiles, we need to define how far apart the vertices are and how they are connected. This will be done on a midthickness surface</span>
<span class="n">gii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemis</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="si">}</span><span class="s1">_space-corobl&#39;</span>\
                 <span class="sa">f</span><span class="s1">&#39;_den-</span><span class="si">{</span><span class="n">den</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_midthickness.surf.gii&#39;</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">gii</span><span class="o">.</span><span class="n">get_arrays_from_intent</span><span class="p">(</span><span class="s1">&#39;NIFTI_INTENT_POINTSET&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">gii</span><span class="o">.</span><span class="n">get_arrays_from_intent</span><span class="p">(</span><span class="s1">&#39;NIFTI_INTENT_TRIANGLE&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># now we can apply the local profile alignment method</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">tdat</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">profile_align</span><span class="p">(</span><span class="n">hipp_dat</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">],</span> <span class="n">patchdist</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">F</span><span class="p">)</span> <span class="c1"># note then when patchdis is not None, we need to include V and F as optional arguments</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tdat</span><span class="p">[</span><span class="mi">500</span><span class="p">:</span><span class="mi">1000</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7ff5b17b4250&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_17_1.png" src="../_images/tutorials_Histology-MRI-9p4T_17_1.png" />
</div>
</div>
<p>Profile_align within 5mm patches seems to give the clean results, but is much slower than aligning to the whole-sample mean. Also this is more susceptible to systematic drift of the images away from the surfaces, which happens in the AHEAD dataset since the different images aren’t perfectly aligned to the blockface image on which surfaces were generated.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Now that we&#39;ve defined our outlier handling and microstructural profile alignment methods, we can apply them to all subjects.</span>
<span class="c1"># Here we also apply z-score normalization for easier comparison between image types, which can otherwise have drastically different ranges.</span>

<span class="n">hipp_dat_clean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">hipp_dat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hipp_dat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">hipp_dat</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">],</span> <span class="p">[</span><span class="mi">126</span><span class="p">,</span><span class="mi">254</span><span class="p">,</span><span class="mi">25</span><span class="p">])</span>
    <span class="c1"># missing data</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">fill_missing</span><span class="p">(</span><span class="n">cdata</span><span class="p">)</span>
    <span class="c1"># profile alignment</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">profile_align</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cdata</span><span class="p">,(</span><span class="n">nverts</span><span class="p">,</span><span class="mi">25</span><span class="p">)),</span><span class="n">V</span><span class="p">,</span><span class="n">F</span><span class="p">)</span>
    <span class="c1"># normalize with interpolated data</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="n">hipp_dat_clean</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cdata</span><span class="p">,[</span><span class="n">nverts</span><span class="p">,</span><span class="mi">25</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># inspect some example maps</span>
<span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">13</span><span class="p">]</span>
<span class="n">cdata</span> <span class="o">=</span> <span class="n">hipp_dat_clean</span><span class="p">[:,:,</span><span class="n">examples</span><span class="p">]</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">cdata</span><span class="p">[:,</span><span class="n">gm</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">den</span><span class="o">=</span><span class="n">den</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">350</span><span class="p">,</span><span class="mi">270</span><span class="p">],</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_20_0.png" src="../_images/tutorials_Histology-MRI-9p4T_20_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;../checkpoints/struct-HISTO-proc&quot;</span><span class="p">,</span><span class="n">hipp_dat_clean</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="2)-Group-average-and-laminar-microstructural-profiles">
<h2>2) Group average and laminar microstructural profiles<a class="headerlink" href="#2)-Group-average-and-laminar-microstructural-profiles" title="Permalink to this heading"></a></h2>
<p>This looks pretty good, so lets run some analyses. First we average within the same stain types, and look at some laminar profiles.</p>
<p>At this stage we will also discard the bigbrain2 (bbhist2) samples since they require further 3D reconstruction refinement at this time. We will also discard the 9.4T MRI data here. We’ll group that together with the 7T MRI data and examine it in that tutorial</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hipp_dat_clean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../checkpoints/struct-HISTO-proc.npy&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># group subjects within the same modality</span>
<span class="n">modalities</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Merker&#39;</span><span class="p">,</span> <span class="s1">&#39;PLI-transmittance&#39;</span><span class="p">,</span> <span class="s1">&#39;Blockface&#39;</span><span class="p">,</span> <span class="s1">&#39;Bieloschowsky&#39;</span><span class="p">,</span> <span class="s1">&#39;Calbindin&#39;</span><span class="p">,</span> <span class="s1">&#39;Calretinin&#39;</span><span class="p">,</span> <span class="s1">&#39;Parvalbumin&#39;</span><span class="p">,</span> <span class="s1">&#39;Thionin&#39;</span><span class="p">]</span><span class="c1">#, &#39;ProtonDensity&#39;, &#39;qR1&#39;, &#39;qR2star&#39;]</span>

<span class="n">modality_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_clean</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">hipp_dat_clean</span><span class="p">[:,:,</span><span class="mi">4</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># EXCLUDING bb2 for now</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">modality_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">modality_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_clean</span><span class="p">[:,:,(</span><span class="n">m</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span><span class="mi">5</span><span class="p">):(</span><span class="n">m</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span><span class="mi">9</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)[:,:,</span><span class="kc">None</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">modality_data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(32004, 25, 8)
</pre></div></div>
</div>
<p>Now we have data in the shape of (number of vertices nV) x (number of depths) x (number of stains)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">modality_data</span><span class="p">[:,</span><span class="n">gm</span><span class="p">,:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">den</span><span class="o">=</span><span class="n">den</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span>  <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_26_0.png" src="../_images/tutorials_Histology-MRI-9p4T_26_0.png" />
</div>
</div>
<p><strong>View Laminar profiles</strong></p>
<p>Here we will view laminar profiles averaged within band across the anterior-posterior and then proximal-distal axes of the hippocampus.</p>
<p>Because we are working with <code class="docutils literal notranslate"><span class="pre">den='unfoldiso'</span></code> surfaces, we can reshape the number of vertices from 32K into 126x254. This way, we can average rows or columns to get a sense of how the profiles are changing in either direction</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">modality_data</span><span class="p">,[</span><span class="mi">126</span><span class="p">,</span><span class="mi">254</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsamp</span><span class="o">=</span><span class="mi">5</span> <span class="c1"># how many band to separate the data into</span>
<span class="n">sampPD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">126</span><span class="p">,</span><span class="n">nsamp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="c1"># get sampling indices by dividing this axis into nsamp bands</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nsamp</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">nsamp</span><span class="p">,</span><span class="mi">1</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">)):</span>

    <span class="c1"># get limites for all axes in this row</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">md</span><span class="p">[:,:,</span><span class="n">gm</span><span class="p">,</span><span class="n">s</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">+</span><span class="mf">.5</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsamp</span><span class="p">):</span>
        <span class="c1"># average within each nsamp band</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="n">sampPD</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">sampPD</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],:,:,</span><span class="n">s</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># colour by intensity, and gry out data outside of the grey matter bounds</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">col</span><span class="p">[:,:][</span><span class="n">depths</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">col</span><span class="p">[:,:][</span><span class="n">depths</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="c1"># plot</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">nsamp</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">depths</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">nsamp</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">nsamp</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span> <span class="n">labelleft</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span>
                <span class="n">labelbottom</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_29_0.png" src="../_images/tutorials_Histology-MRI-9p4T_29_0.png" />
</div>
</div>
<p>Note that for some stains, there is considerable variation in the shape of profiles across this axis. The first row (Merker stain) is a good example, which goes from a tight distribution at the distal areas (such as CA2 and CA3) to a shallower, almost bimodal distribution at the proximal areas (subiculum)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nsamp</span><span class="o">=</span><span class="mi">5</span> <span class="c1"># how many band to separate the data into</span>
<span class="n">sampAP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">254</span><span class="p">,</span><span class="n">nsamp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="c1"># get sampling indices by dividing this axis into nsamp bands</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nsamp</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="n">nsamp</span><span class="p">,</span><span class="mi">1</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modalities</span><span class="p">)):</span>

    <span class="c1"># get limites for all axes in this row</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">md</span><span class="p">[:,:,</span><span class="n">gm</span><span class="p">,</span><span class="n">s</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">+</span><span class="mf">.5</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsamp</span><span class="p">):</span>
        <span class="c1"># average within each nsamp band</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">md</span><span class="p">[:,</span><span class="n">sampAP</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">sampAP</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],:,</span><span class="n">s</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># colour by intensity, and gry out data outside of the grey matter bounds</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
        <span class="n">col</span><span class="p">[:,:][</span><span class="n">depths</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">col</span><span class="p">[:,:][</span><span class="n">depths</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="c1"># plot</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">nsamp</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">depths</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">nsamp</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">lims</span><span class="p">)</span>
        <span class="c1"># ax[s,nsamp-i-1].axis(&#39;off&#39;)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">nsamp</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span> <span class="n">labelleft</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span>
                <span class="n">labelbottom</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_31_0.png" src="../_images/tutorials_Histology-MRI-9p4T_31_0.png" />
</div>
</div>
<p>Here we see that profiles are relatively constant between rows. This means that profiles don’t differ as greatly across the anterior-posterior extent of the hippocampus.</p>
</section>
<section id="3)-Summarize-data-according-to-primary-gradients">
<h2>3) Summarize data according to primary gradients<a class="headerlink" href="#3)-Summarize-data-according-to-primary-gradients" title="Permalink to this heading"></a></h2>
<p>Dimensionality reduction allows us to summarize many maps as primary components, or Gradients. Here we will use BrainSpace to compute nonlinear Gradients using diffusion map embedding. Briefly, this typically consists of computing an affinity matrix (e.g. a correlation between all maps) and then grouping them into a few consistent patterns (Gradients). In this case, we will consider not only the correlation between maps, but also across depths. All depths from a given vertex are sometimes called
microstructural profiles (MPs), and the similarity between all profiles is thus a microstructural profile covariance (MPC) matrix. In this case we also consider multiple modalities, making a multimodal MPC (mMPC).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># here, we will use a few more tools (build_mpc is borrowed from micapipe)</span>

<span class="kn">from</span> <span class="nn">hippomaps.build_mpc</span> <span class="kn">import</span> <span class="n">build_mpc</span>
<span class="kn">from</span> <span class="nn">brainspace.gradient</span> <span class="kn">import</span> <span class="n">GradientMaps</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">modality_data</span><span class="p">[:,</span><span class="n">gm</span><span class="p">,:],(</span><span class="mi">126</span><span class="o">*</span><span class="mi">254</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="c1">#flatten. Each vertex now has a vector of depths for all modalities.</span>
<span class="n">mMPC</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">problemNodes</span> <span class="o">=</span> <span class="n">build_mpc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">mMP</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mMP</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))))</span> <span class="c1"># compute mMPC</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/export03/data/hippomaps/hippomaps/build_mpc.py:116: RuntimeWarning: divide by zero encountered in true_divide
  MPC = 0.5 * np.log( np.divide(1 + R, 1 - R) )
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the mMPC to get a sense of similarity between vertices.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mMPC</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(-0.5, 32003.5, 32003.5, -0.5)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_36_1.png" src="../_images/tutorials_Histology-MRI-9p4T_36_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># multimodal gradient map (mGM) decomposition using default parameters</span>
<span class="n">mGM</span> <span class="o">=</span> <span class="n">GradientMaps</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">mGM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mMPC</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
GradientMaps(n_components=5)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># As above, we can make a nice plot for each of the resulting gradients</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">mGM</span><span class="o">.</span><span class="n">gradients_</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">den</span><span class="o">=</span><span class="n">den</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span>  <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_38_0.png" src="../_images/tutorials_Histology-MRI-9p4T_38_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we can also see the lambda value (or eigenvalue) for each gradient</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGM</span><span class="o">.</span><span class="n">lambdas_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7fce8c291310&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Histology-MRI-9p4T_39_1.png" src="../_images/tutorials_Histology-MRI-9p4T_39_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert into a percentage of explained variance</span>
<span class="n">mGM</span><span class="o">.</span><span class="n">lambdas_</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mGM</span><span class="o">.</span><span class="n">lambdas_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([0.4627413 , 0.26960774, 0.14327609, 0.07741928, 0.04695559])
</pre></div></div>
</div>
<p><strong>save</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save a copy of the 2D map</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BigBrain&#39;</span><span class="p">,</span><span class="s1">&#39;BigBrain&#39;</span><span class="p">,</span><span class="s1">&#39;AxerPLI&#39;</span><span class="p">,</span><span class="s1">&#39;AHEAD&#39;</span><span class="p">,</span><span class="s1">&#39;AHEAD&#39;</span><span class="p">,</span><span class="s1">&#39;AHEAD&#39;</span><span class="p">,</span><span class="s1">&#39;AHEAD&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">modality</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modalities</span><span class="p">):</span>
    <span class="n">cdat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">modality_data</span><span class="p">[:,:,</span><span class="n">gm</span><span class="p">,</span><span class="n">m</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cdat</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
    <span class="n">image</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;histology&quot;</span> <span class="k">if</span> <span class="n">m</span><span class="o">&lt;</span><span class="mi">8</span> <span class="k">else</span> <span class="s2">&quot;MRI-9p4T&quot;</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span> <span class="k">if</span> <span class="n">m</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;4&quot;</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../maps/HippoMaps-initializationMaps/Dataset-</span><span class="si">{</span><span class="n">dataset</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">modality</span><span class="si">}</span><span class="s1">_average-</span><span class="si">{</span><span class="n">sample</span><span class="si">}</span><span class="s1">_hemi-mix_den-</span><span class="si">{</span><span class="n">den</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<script type="application/vnd.jupyter.widget-state+json">
{"state": {}, "version_major": 2, "version_minor": 0}
</script></section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Morphology.html" class="btn btn-neutral float-left" title="Morphology" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MRI-7T-struct.html" class="btn btn-neutral float-right" title="MRI-7T-struct" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, DeKraker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>