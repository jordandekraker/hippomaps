<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overview &mdash; Hippomaps 0.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=e031e9a9"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Overview" href="MRI-3T-rsfMRI.html" />
    <link rel="prev" title="Overview" href="Histology-MRI-9p4T.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Hippomaps
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Morphology.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="Morphology.html#Histology">Histology</a></li>
<li class="toctree-l2"><a class="reference internal" href="Morphology.html#7T-MRI">7T MRI</a></li>
<li class="toctree-l2"><a class="reference internal" href="Morphology.html#3T-MRI">3T MRI</a></li>
<li class="toctree-l2"><a class="reference internal" href="Histology-MRI-9p4T.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="Histology-MRI-9p4T.html#0)-Map-volumetric-data-to-surfaces-and-load-(optional)">0) Map volumetric data to surfaces and load (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="Histology-MRI-9p4T.html#1)-Load-and-plot-all-surface-data">1) Load and plot all surface data</a></li>
<li class="toctree-l2"><a class="reference internal" href="Histology-MRI-9p4T.html#2)-Average-eqivalent-samples-and-view-profiles">2) Average eqivalent samples and view profiles</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#0)-Map-volumetric-data-to-surfaces-and-load-(optional)">0) Map volumetric data to surfaces and load (optional)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#1)-Load-and-plot-all-surface-data">1) Load and plot all surface data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#2)-Stability-between-subjects">2) Stability between subjects</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3)-lets-add-another-dataset-(9.4T-data)">3) lets add another dataset (9.4T data)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#4)-Make-a-summary-plot-of-consistency">4) Make a summary plot of consistency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#4)-Summarize-data-according-to-primary-gradients">4) Summarize data according to primary gradients</a></li>
<li class="toctree-l3"><a class="reference internal" href="#save">save</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-rsfMRI.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-rsfMRI.html#3)-tSNR-(TODO:-get-volumetric-version-generated-from-micapipe)">3) tSNR (TODO: get volumetric version generated from micapipe)</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-rsfMRI.html#5)-Check-consistency-for-all-of-the-above">5) Check consistency for all of the above</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-rsfMRI.html#save">save</a></li>
<li class="toctree-l2"><a class="reference internal" href="iEEG.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="DimReduct.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="DimReduct.html#1)-Load-and-resample">1) Load and resample</a></li>
<li class="toctree-l2"><a class="reference internal" href="DimReduct.html#2)-Check-for-correlations-with-AP,-PD,-or-subfield-organizations">2) Check for correlations with AP, PD, or subfield organizations</a></li>
<li class="toctree-l2"><a class="reference internal" href="DimReduct.html#3)-Gradient-decomposition">3) Gradient decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html#Now-that-we've-run-through-a-full-example-for-one-subject,-we'll-loop-through-all-subjects-and-save-the-data:">Now that we’ve run through a full example for one subject, we’ll loop through all subjects and save the data:</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html#significance-testing">significance testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html#Additional-consistency-checks">Additional consistency checks</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html#1.3)-Consider-neocortical-results">1.3) Consider neocortical results</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html#1.4)-Compare-to-previously-mapped-features">1.4) Compare to previously mapped features</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html#2.3)-Consider-the-neocortex">2.3) Consider the neocortex</a></li>
<li class="toctree-l2"><a class="reference internal" href="MRI-3T-taskfMRI.html#3.3)-Consider-the-neocortex">3.3) Consider the neocortex</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Overview of functions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Hippomaps</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Overview</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/MRI-7T-struct.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Overview">
<h1>Overview<a class="headerlink" href="#Overview" title="Permalink to this heading"></a></h1>
<p>This notebook will examine quantitative 7T MRI measures projected onto hippocampal surfaces and averaged across 10 subjects. Then we will combine this with 9.4T ex-vivo MRI data and examine conserved features using dimensionality reduction to see common patterns across all structural MRI maps.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">hippomaps</span> <span class="k">as</span> <span class="nn">hm</span>
<span class="kn">import</span> <span class="nn">scipy</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># locate input data</span>
<span class="n">micapipe_dir</span> <span class="o">=</span> <span class="s1">&#39;../../publication-hippomaps/sourcedata/Supersession_PNI&#39;</span>
<span class="n">hippunfold_dir</span> <span class="o">=</span> <span class="s1">&#39;../../publication-hippomaps/hippunfold/PNI_v1.3.0_super/hippunfold&#39;</span>

<span class="c1"># define which subjects and surfaces to examine</span>
<span class="n">subs_7T</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PNC002&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC003&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC006&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC007&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC009&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC010&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC015&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC016&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC018&#39;</span><span class="p">,</span> <span class="s1">&#39;PNC019&#39;</span><span class="p">]</span>
<span class="n">ses</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">hemis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hipp&#39;</span><span class="p">]</span><span class="c1">#,&#39;dentate&#39;]</span>
<span class="n">den</span> <span class="o">=</span> <span class="s1">&#39;0p5mm&#39;</span>

<span class="c1"># here we will generate multiple depth-wise surfaces</span>
<span class="n">depths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">1.25</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">gm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">depths</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span>  <span class="n">depths</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># get expected number of vertices and their indices</span>
<span class="n">nV</span><span class="p">,</span><span class="n">iV</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_nVertices</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">den</span><span class="p">)</span>

<span class="c1"># loop through these types of structural images</span>
<span class="n">features_7T</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;qT1&#39;</span><span class="p">,</span><span class="s1">&#39;MTR&#39;</span><span class="p">,</span><span class="s1">&#39;T2star&#39;</span><span class="p">,</span><span class="s1">&#39;FA&#39;</span><span class="p">,</span><span class="s1">&#39;ADC&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="0)-Map-volumetric-data-to-surfaces-and-load-(optional)">
<h1>0) Map volumetric data to surfaces and load (optional)<a class="headerlink" href="#0)-Map-volumetric-data-to-surfaces-and-load-(optional)" title="Permalink to this heading"></a></h1>
<p>As in all tutorials here, this step is optional, and provides an example of how data can be mapped to hippocampal surfaces outside of python (using ANTs and/or wb_command). This relies on having the data stored locally, and should be considered example code. This code may differ depending on where/how your data is stored and formatted, and so may require some customization for new projects. For the purposes of this tutorial, we provide a matrix of loaded data at the end, so skip to step 1).</p>
<p>In this example, we loop through subjects, hemipsheres, and generate surfaces at different depths using the <code class="docutils literal notranslate"><span class="pre">wb_command</span></code> tool. Then, we loop through each modality and sample the data to those surfaces. Finally, we load the data from all surfaces into a single matrix.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note that all data is already aligned in space-T1w AKA space-nativepro!</span>

<span class="c1"># intialize the matrix for loading data into</span>
<span class="n">hipp_dat_7T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nV</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">hemis</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">depths</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="o">!</span>mkdir<span class="w"> </span>-p<span class="w"> </span>tmp<span class="w"> </span>#<span class="w"> </span>store<span class="w"> </span>intermediate<span class="w"> </span>files<span class="w"> </span>temporarily

<span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs_7T</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">depth</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">depths</span><span class="p">):</span>

                <span class="c1"># create surface depths</span>
                <span class="n">cmd1</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -surface-cortex-layer &#39;</span>\
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-</span><span class="si">{</span><span class="n">den</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_inner.surf.gii &#39;</span>\
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">hippunfold_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/surf/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_space-T1w_den-</span><span class="si">{</span><span class="n">den</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_outer.surf.gii &#39;</span>\
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s1"> &#39;</span>\
                    <span class="sa">f</span><span class="s1">&#39;tmp/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s1">.surf.gii&#39;</span>
                <span class="o">!{</span>cmd1<span class="o">}</span>

                <span class="c1"># sample data to each surface</span>
                <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_7T</span><span class="p">):</span>
                    <span class="n">cmd2</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;wb_command -volume-to-surface-mapping &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">micapipe_dir</span><span class="si">}</span><span class="s1">/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">/anat/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_space-nativepro_</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">.nii.gz &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;tmp/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s1">.surf.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;tmp/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">.shape.gii &#39;</span>\
                        <span class="sa">f</span><span class="s1">&#39;-trilinear&#39;</span>
                    <span class="o">!{</span>cmd2<span class="o">}</span>

                    <span class="c1"># now load the data!</span>
                    <span class="n">surfdata</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tmp/sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1">_hemi-</span><span class="si">{</span><span class="n">hemi</span><span class="si">}</span><span class="s1">_label-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">_layer-</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">.shape.gii&#39;</span><span class="p">)</span>
                    <span class="n">hipp_dat_7T</span><span class="p">[</span><span class="n">iV</span><span class="p">[</span><span class="n">l</span><span class="p">],</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">surfdata</span><span class="o">.</span><span class="n">darrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{</span><span class="n">sub</span><span class="si">}</span><span class="s1"> done&#39;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;../checkpoints/MRI-7T-struct_unproc&quot;</span><span class="p">,</span><span class="n">hipp_dat_7T</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">!</span>rm<span class="w"> </span>-rf<span class="w"> </span>tmp
</pre></div>
</div>
</div>
</section>
<section id="1)-Load-and-plot-all-surface-data">
<h1>1) Load and plot all surface data<a class="headerlink" href="#1)-Load-and-plot-all-surface-data" title="Permalink to this heading"></a></h1>
<p>Here, we use the data already loaded into a large matrix from step 0). This matrix <code class="docutils literal notranslate"><span class="pre">hipp_dat_7T</span></code> has a shape of (number of vertices nV) x (number of hemsipheres 2) x (number of subjects) x (number of surface depths) x (number of features or image types)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data</span>
<span class="n">hipp_dat_7T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../checkpoints/MRI-7T-struct_unproc.npy&quot;</span><span class="p">)</span>

<span class="c1"># Preprocess</span>
<span class="c1"># Profile align the depths of each column (as in https://github.com/jordandekraker/hippomaps/blob/master/tutorials/Histology-MRI-9p4T.ipynb)</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_7T</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs_7T</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
            <span class="n">hipp_dat_7T</span><span class="p">[:,</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">,:,</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">profile_align</span><span class="p">(</span><span class="n">hipp_dat_7T</span><span class="p">[:,</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">,:,</span><span class="n">f</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/export03/data/opt/venv/lib/python3.8/site-packages/numpy/lib/function_base.py:2691: RuntimeWarning: invalid value encountered in true_divide
  c /= stddev[:, None]
/export03/data/opt/venv/lib/python3.8/site-packages/numpy/lib/function_base.py:2692: RuntimeWarning: invalid value encountered in true_divide
  c /= stddev[None, :]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># that step can be quite slow, so we&#39;ll save a checkpoint so we can more easily resume from there without having to redo everything</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;../checkpoints/MRI-7T-struct_proc&quot;</span><span class="p">,</span><span class="n">hipp_dat_7T</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hipp_dat_7T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../checkpoints/MRI-7T-struct_proc.npy&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now lets use our plotting tools to make a nice plot, averaging across depths and hemispheres and subjects</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdata</span> <span class="o">=</span> <span class="n">hipp_dat_7T</span><span class="p">[:,:,:,</span><span class="n">gm</span><span class="p">,:]</span> <span class="c1"># trim the data that is not actually inside our grey matter bound</span>
<span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># average over subjects, hemispheres, and depths for visualization</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">),</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hipp&#39;</span><span class="p">],</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_10_0.png" src="../_images/tutorials_MRI-7T-struct_10_0.png" />
</div>
</div>
<section id="2)-Stability-between-subjects">
<h2>2) Stability between subjects<a class="headerlink" href="#2)-Stability-between-subjects" title="Permalink to this heading"></a></h2>
<p>To make sure our measures are consistent, we will check whether they are correlated across samples (that is, across subjects and hemipsheres)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># again average across depths for a given feature (feature 0 )</span>
<span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_7T</span><span class="p">[:,:,:,</span><span class="n">gm</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># reshape so subject hemispheres are listed in the same dimension</span>
<span class="n">cdata</span> <span class="o">=</span> <span class="n">cdata</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">7262</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">cdata</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(7262, 20)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now we can see the vertex-wise correlation between all 20 subject hemispheres</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdata</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7f3aa038bf10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_13_1.png" src="../_images/tutorials_MRI-7T-struct_13_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now repeat for all features and make a histogram of the off-diagonal values</span>
<span class="n">mfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sdfcorr</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
    <span class="n">cdat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_7T</span><span class="p">[:,:,:,</span><span class="n">gm</span><span class="p">,</span><span class="n">f</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">7262</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># as above</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="c1"># as above 2</span>
    <span class="n">fcorr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="c1"># this return only the off-diagonal (lower left triangle)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fcorr</span><span class="p">)</span> <span class="c1"># make a histogram for this particular feature</span>
    <span class="n">mfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
    <span class="n">sdfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_14_0.png" src="../_images/tutorials_MRI-7T-struct_14_0.png" />
</div>
</div>
<p>These are some nice correlations; consistently above zero!</p>
</section>
<section id="3)-lets-add-another-dataset-(9.4T-data)">
<h2>3) lets add another dataset (9.4T data)<a class="headerlink" href="#3)-lets-add-another-dataset-(9.4T-data)" title="Permalink to this heading"></a></h2>
<p>In this case, data was samples on a denser surface (<code class="docutils literal notranslate"><span class="pre">den='unfoldiso'</span></code>). Thus we will have to interpolate it to the <code class="docutils literal notranslate"><span class="pre">den='0p5mm'</span></code> surfaces that we’ve been using so far</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add in 9.4T data that we already preprocessed in https://github.com/jordandekraker/hippomaps/blob/master/tutorials/Histology-MRI-9p4T.ipynb</span>

<span class="n">features_9p4T</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PD&#39;</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;R2star&#39;</span><span class="p">]</span>
<span class="n">subs_9p4T</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;122017&#39;</span><span class="p">,</span> <span class="s1">&#39;152017&#39;</span><span class="p">]</span>

<span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;../checkpoints/struct-HISTO-proc.npy&quot;</span><span class="p">)[:,:,</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="mi">3</span><span class="p">:]</span> <span class="c1"># only the last set of 12 maps are from 9.4T MRI; the others are from histology and so we will discard them</span>

<span class="c1"># downsample to 0p5mm and format as above</span>
<span class="n">hipp_dat_9p4T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nV</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">hemis</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">depths</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">features_9p4T</span><span class="p">)])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="c1"># resample</span>
<span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">depth</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">depths</span><span class="p">):</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">featue</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_9p4T</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subs_9p4T</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">hemi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hemis</span><span class="p">):</span>
                <span class="n">hipp_dat_9p4T</span><span class="p">[:,</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">],</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">density_interp</span><span class="p">(</span><span class="s1">&#39;unfoldiso&#39;</span><span class="p">,</span><span class="s1">&#39;0p5mm&#39;</span><span class="p">,</span><span class="n">tmp</span><span class="p">[:,</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">],</span><span class="s1">&#39;hipp&#39;</span><span class="p">)</span>
                <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cdata</span> <span class="o">=</span> <span class="n">hipp_dat_9p4T</span><span class="p">[:,:,:,</span><span class="n">gm</span><span class="p">,:]</span> <span class="c1"># trim the data that is not actually inside our grey matter bound</span>
<span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="c1"># average over subjects, hemispheres, and depths for visualization</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">cdata</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">),</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hipp&#39;</span><span class="p">],</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_18_0.png" src="../_images/tutorials_MRI-7T-struct_18_0.png" />
</div>
</div>
<p>As above, we will check whether measures are correlated across samples (that is, across subjects and hemipsheres)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_9p4T</span><span class="p">[:,:,:,</span><span class="n">gm</span><span class="p">,</span><span class="n">f</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">7262</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7f3a6fb9ac10&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_20_1.png" src="../_images/tutorials_MRI-7T-struct_20_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">features_9p4T</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">features_9p4T</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_9p4T</span><span class="p">):</span>
    <span class="n">cdat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_9p4T</span><span class="p">[:,:,:,</span><span class="n">gm</span><span class="p">,</span><span class="n">f</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">7262</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">cdat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">fcorr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">fcorr</span><span class="p">)</span>
    <span class="n">mfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
    <span class="n">sdfcorr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">fcorr</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_21_0.png" src="../_images/tutorials_MRI-7T-struct_21_0.png" />
</div>
</div>
<p>Not as nice looking as before, since we only have 4 samples to look at. But still correlations are well above zero!</p>
</section>
<section id="4)-Make-a-summary-plot-of-consistency">
<h2>4) Make a summary plot of consistency<a class="headerlink" href="#4)-Make-a-summary-plot-of-consistency" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># combine the two datasets</span>
<span class="n">xnames</span> <span class="o">=</span> <span class="n">features_9p4T</span> <span class="o">+</span> <span class="n">features_7T</span>
<span class="c1"># reorder to match what&#39;s written in the manuscript</span>
<span class="n">myorder</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">xnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">xnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myorder</span><span class="p">]</span>
<span class="n">mfcorr</span> <span class="o">=</span> <span class="p">[</span><span class="n">mfcorr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myorder</span><span class="p">]</span>
<span class="n">sdfcorr</span> <span class="o">=</span> <span class="p">[</span><span class="n">sdfcorr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myorder</span><span class="p">]</span>

<span class="c1"># instead of histograms, we will show a bar plot of the average and standard deviation</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">features_9p4T</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="n">mfcorr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="n">mfcorr</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">sdfcorr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="n">xnames</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mf">.9</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_24_0.png" src="../_images/tutorials_MRI-7T-struct_24_0.png" />
</div>
</div>
</section>
<section id="4)-Summarize-data-according-to-primary-gradients">
<h2>4) Summarize data according to primary gradients<a class="headerlink" href="#4)-Summarize-data-according-to-primary-gradients" title="Permalink to this heading"></a></h2>
<p>Dimensionality reduction allows us to summarize many maps as primary components, or Gradients. Here we will use BrainSpace to compute nonlinear Gradients using diffusion map embedding. Briefly, this typically consists of computing an affinity matrix (e.g. a correlation between all maps) and then grouping them into a few consistent patterns (Gradients). In this case, we will consider not only the correlation between maps, but also across depths. All depths from a given vertex are sometimes called
microstructural profiles (MPs), and the similarity between all profiles is thus a microstructural profile covariance (MPC) matrix. In this case we also consider multiple modalities, making a multimodal MPC (mMPC).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># here, we will use a few more tools (build_mpc is borrowed from micapipe)</span>

<span class="kn">from</span> <span class="nn">hippomaps.build_mpc</span> <span class="kn">import</span> <span class="n">build_mpc</span>
<span class="kn">from</span> <span class="nn">brainspace.gradient</span> <span class="kn">import</span> <span class="n">GradientMaps</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># as before, we will average across subjects and hemispheres, giving us a total of 8 features that are group-averaged maps. This time we don&#39;t average depths though.</span>

<span class="n">modality_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_9p4T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_7T</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))),</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">modality_data</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(7262, 25, 8)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">modality_data</span><span class="p">[:,</span><span class="n">gm</span><span class="p">,:],(</span><span class="n">nV</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span> <span class="c1">#flatten. Each vertex now has a vector of depths for all modalities.</span>
<span class="n">mMPC</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">problemNodes</span> <span class="o">=</span> <span class="n">build_mpc</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">mMP</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mMP</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)))))</span> <span class="c1"># compute mMPC</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/data/mica1/01_programs/micapipe-v0.2.0/functions/build_mpc.py:116: RuntimeWarning: divide by zero encountered in true_divide
  MPC = 0.5 * np.log( np.divide(1 + R, 1 - R) )
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plot the mMPC to get a sense of similarity between vertices.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mMPC</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;bwr&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(-0.5, 7261.5, 7261.5, -0.5)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_29_1.png" src="../_images/tutorials_MRI-7T-struct_29_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># multimodal gradient map (mGM) decomposition using default parameters</span>
<span class="n">mGM</span> <span class="o">=</span> <span class="n">GradientMaps</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">mGM</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mMPC</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/export03/data/opt/venv/lib/python3.8/site-packages/brainspace/gradient/embedding.py:70: UserWarning: Affinity is not symmetric. Making symmetric.
  warnings.warn(&#39;Affinity is not symmetric. Making symmetric.&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
GradientMaps(n_components=5)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># As above, we can make a nice plot for each of the resulting gradients</span>
<span class="n">hm</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">surfplot_canonical_foldunfold</span><span class="p">(</span><span class="n">mGM</span><span class="o">.</span><span class="n">gradients_</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hipp&#39;</span><span class="p">],</span> <span class="n">hemis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">],</span> <span class="n">unfoldAPrescale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">den</span><span class="o">=</span><span class="s1">&#39;0p5mm&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;plasma&#39;</span><span class="p">,</span> <span class="n">color_bar</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">share</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span>  <span class="n">tighten_cwindow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">embed_nb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_31_0.png" src="../_images/tutorials_MRI-7T-struct_31_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we can also see the lambda value (or eigenvalue) for each gradient</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">mGM</span><span class="o">.</span><span class="n">lambdas_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&lt;matplotlib.lines.Line2D at 0x7f3a7814be80&gt;]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_MRI-7T-struct_32_1.png" src="../_images/tutorials_MRI-7T-struct_32_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># convert into a percentage of explained variance</span>
<span class="n">mGM</span><span class="o">.</span><span class="n">lambdas_</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mGM</span><span class="o">.</span><span class="n">lambdas_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([0.48416778, 0.28227002, 0.1051938 , 0.06996862, 0.05839978])
</pre></div></div>
</div>
</section>
<section id="save">
<h2>save<a class="headerlink" href="#save" title="Permalink to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save 2D maps (7T)</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_7T</span><span class="p">):</span>
    <span class="n">cdat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_7T</span><span class="p">[:,:,:,</span><span class="n">gm</span><span class="p">,</span><span class="n">f</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cdat</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
    <span class="n">image</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../maps/HippoMaps-initializationMaps/Dataset-PNI/MRI-7T-</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">_average-20_hemi-mix_den-0p5mm_label-hipp.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># save 2D maps (9.4T)</span>
<span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features_9p4T</span><span class="p">):</span>
    <span class="n">cdat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hipp_dat_9p4T</span><span class="p">[:,:,:,</span><span class="n">gm</span><span class="p">,</span><span class="n">f</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">data_array</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiDataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cdat</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">gifti</span><span class="o">.</span><span class="n">GiftiImage</span><span class="p">()</span>
    <span class="n">image</span><span class="o">.</span><span class="n">add_gifti_data_array</span><span class="p">(</span><span class="n">data_array</span><span class="p">)</span>
    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;../maps/HippoMaps-initializationMaps/Dataset-AHEAD/MRI-9p4T-</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">_average-4_hemi-mix_den-0p5mm_label-hipp.shape.gii&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<script type="application/vnd.jupyter.widget-state+json">
{"state": {}, "version_major": 2, "version_minor": 0}
</script></section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Histology-MRI-9p4T.html" class="btn btn-neutral float-left" title="Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MRI-3T-rsfMRI.html" class="btn btn-neutral float-right" title="Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, DeKraker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>